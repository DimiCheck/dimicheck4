<!DOCTYPE html>
<html lang="ko">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-NX4P51JHZD"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-NX4P51JHZD');
  </script>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <meta name="theme-color" content="#0b0f14"/>
  <meta name="application-name" content="DIMI Check"/>
  <meta name="mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <link rel="manifest" href="/manifest.webmanifest">
  <script>
    (function(){
      try{
        const raw = localStorage.getItem('dimicheck:settings');
        if(!raw) return;
        const parsed = JSON.parse(raw);
        if(parsed.theme === 'light' || parsed.theme === 'dark'){
          document.documentElement.dataset.theme = parsed.theme;
        }else{
          delete document.documentElement.dataset.theme;
        }
      }catch(error){
        console.warn('[Theme] preload failed', error);
      }
    })();
  </script>
  <script defer src="/js/pwa.js"></script>
  <script defer src="/js/preferences.js"></script>
  <script defer src="/js/notifications.js"></script>
  <title>í•™êµ ìƒí™œ | Today</title>
  <meta name="color-scheme" content="light dark" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="apple-touch-icon" sizes="180x180" href="src/favicon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="src/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="src/favicon/favicon-16x16.png">
  <style>
    :root{
      --bg: #0b0f14;
      --bg-2: #0e1218;
      --card: rgba(255,255,255,.08);
      --card-2: rgba(255,255,255,.06);
      --text: #e9eef6;
      --muted: #a7b0c0;
      --primary: #d04fff;
      --primary-2: #ff6ad0;
      --ring: 0 0 0 8px color-mix(in oklab, var(--primary) 30%, transparent);
      --shadow: 0 10px 30px rgba(0, 0, 0, .45);
      --radius: 20px;
      --ok: #38d67a;
      --warn: #ffb020;
      --err: #ff5c5c;
    }
    :root[data-theme="light"]{
      --bg: #f6f8fb;
      --bg-2: #eef2f8;
      --card: rgba(255,255,255,.75);
      --card-2: rgba(255,255,255,.6);
      --text: #0f172a;
      --muted: #5b6475;
      --primary: #d04fff;
      --primary-2: #ff6ad0;
      --shadow: 0 10px 30px rgba(57,72,103,.15);
    }
    :root[data-theme="dark"]{
      --bg: #0b0f14;
      --bg-2: #0e1218;
      --card: rgba(255,255,255,.08);
      --card-2: rgba(255,255,255,.06);
      --text: #e9eef6;
      --muted: #a7b0c0;
      --primary: #d04fff;
      --primary-2: #ff6ad0;
      --shadow: 0 10px 30px rgba(0, 0, 0, .45);
    }
    @media (prefers-color-scheme: light) {
      :root:not([data-theme="dark"]) {
        --bg: #f6f8fb;
        --bg-2: #eef2f8;
        --card: rgba(255,255,255,.75);
        --card-2: rgba(255,255,255,.6);
        --text: #0f172a;
        --muted: #5b6475;
        --primary: #d04fff;
        --primary-2: #ff6ad0;
        --shadow: 0 10px 30px rgba(57,72,103,.15);
      }
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:"Pretendard",system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;
      color:var(--text); background:var(--bg);
      display:block; overflow:auto;
    }

    /* background blobs */
    .blob-container{
      position:fixed; inset:0; overflow:hidden; z-index:-1;
      background: radial-gradient(1200px 800px at 10% -10%, #5a6cff20, transparent 60%),
                  radial-gradient(1200px 800px at 110% 10%, #ff009025, transparent 60%),
                  radial-gradient(1000px 700px at 50% 120%, #ff00b325, transparent 60%);
    }
    .blob{position:absolute; filter:blur(40px); opacity:.6; pointer-events:none}
    .b1{width:48vw;height:48vw;background:radial-gradient(circle,#ff6a6a60,transparent 70%); top:-10vh; left:-10vw; animation:float 18s ease-in-out infinite}
    .b2{width:42vw;height:42vw;background:radial-gradient(circle,#e100ff50,transparent 70%); bottom:-15vh; right:-10vw; animation:float 22s ease-in-out infinite reverse}
    .b3{width:36vw;height:36vw;background:radial-gradient(circle,#ff6ae950,transparent 70%); top:40vh; left:10vw; animation:float 26s ease-in-out infinite}
    @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-20px)}}

    /* shell */
    header{
      position:sticky; top:0; z-index:5;
      padding:16px clamp(12px,3vw,24px);
      backdrop-filter:saturate(140%) blur(12px);
      background:linear-gradient(180deg,var(--card),transparent);
      border-bottom:1px solid color-mix(in oklab, var(--text) 10%, transparent);
    }
    .toolbar{display:flex; gap:8px; align-items:center; justify-content:space-between; flex-wrap:wrap}
    .title{font-weight:800; letter-spacing:.2px; display:flex; gap:10px; align-items:center}
    .title .dot{width:12px;height:12px;border-radius:999px; background:var(--primary); box-shadow:0 0 10px color-mix(in oklab,var(--primary) 50%, transparent)}
    .controls{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    select,button{
      height:40px; padding:0 12px; border-radius:12px; border:1px solid color-mix(in oklab, var(--text) 15%, transparent);
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      color:var(--text); font-weight:600; cursor:pointer;
      transition:all .2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    button:active{
      transform:scale(0.96);
      box-shadow:0 0 0 4px color-mix(in oklab, var(--primary) 15%, transparent);
    }
    button.cta{background:linear-gradient(135deg,var(--primary),var(--primary-2)); color:#fff; border:0}
    button.cta:active{
      box-shadow:0 0 0 4px color-mix(in oklab, var(--primary) 20%, transparent), 0 4px 12px rgba(208, 79, 255, .3);
    }
    button.ghost{background:transparent}
    button.ghost:active{
      box-shadow:0 0 0 4px color-mix(in oklab, var(--text) 10%, transparent);
    }

    main{
      width:min(1100px,92vw); margin:18px auto 28px; display:grid; gap:18px;
      grid-template-columns:1fr 1fr;
      grid-template-areas:"left right" "countdown countdown" "calendar calendar";
    }
    @media (max-width: 980px){ main{grid-template-columns:1fr; grid-template-areas:"left" "right" "countdown" "calendar"} }

    .panel{
      grid-area:var(--area);
      position:relative; overflow:clip; border-radius:var(--radius);
      background:linear-gradient(180deg,var(--card),var(--card-2));
      backdrop-filter:saturate(140%) blur(14px); box-shadow:var(--shadow);
      padding:20px;
    }
    .head{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:10px}
    .head h2{margin:0; font-size:18px}
    .sub{color:var(--muted); font-size:13px}

    .list{display:grid; gap:8px}
    .row{
      display:grid; grid-template-columns:64px 1fr; gap:10px; align-items:start;
      padding:12px; border:1px solid color-mix(in oklab, var(--text) 12%, transparent); border-radius:14px;
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
    }
    .period{font-weight:800; text-align:center; border-right:1px dashed color-mix(in oklab, var(--text) 20%, transparent)}
    .subject{font-weight:700}
    .empty{padding:14px; border:1px dashed color-mix(in oklab, var(--text) 18%, transparent); border-radius:12px; color:var(--muted)}

    .meal-grid{display:grid; grid-template-columns:repeat(3,1fr); gap:10px}
    @media (max-width:700px){ .meal-grid{grid-template-columns:1fr} }
    .meal-card{
      padding:14px; border-radius:16px; border:1px solid color-mix(in oklab, var(--text) 12%, transparent);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
    }
    .meal-card h3{margin:0 0 8px; font-size:16px}
    .meal-card ul{margin:0; padding-left:18px}
    .meal-card li{margin:2px 0}

    .time{position:absolute; top:16px; right:16px; font-size:12px; color:var(--muted)}

    /* modal for weekly timetable + meal from etc.js style */
    .modal-overlay{
      position:fixed; inset:0; background:rgba(0,0,0,.35); backdrop-filter:blur(6px);
      display:grid; place-items:center; opacity:0; pointer-events:none; transition:.2s ease;
      z-index:50;
    }
    .modal-overlay.visible{opacity:1; pointer-events:auto}
    .modal{
      width:min(920px,92vw); max-height:80vh; overflow:auto;
      background:linear-gradient(180deg,var(--card),var(--card-2)); border:1px solid color-mix(in oklab, var(--text) 14%, transparent);
      border-radius:18px; box-shadow:var(--shadow); padding:18px;
    }
    .modal .modal-head{display:flex; justify-content:space-between; align-items:center; gap:8px; margin-bottom:12px}
    .modal .modal-title{margin:0; font-size:18px}
    .modal .modal-close{height:36px; aspect-ratio:1/1; border-radius:10px; border:1px solid color-mix(in oklab, var(--text) 12%, transparent); background:transparent; color:var(--text); font-size:20px}
    .modal table{width:100%; border-collapse:collapse; font-size:14px}
    .modal th,.modal td{border:1px solid color-mix(in oklab, var(--text) 14%, transparent); padding:8px 10px; text-align:center}
    .modal thead th{position:sticky; top:0; background:color-mix(in oklab, var(--card) 80%, rgba(255,255,255,.1));}

    .fade-up{opacity:0; transform:translateY(10px); animation:rise .6s ease forwards}
    @keyframes rise{to{opacity:1; transform:none}}

    .spacer {
      height: calc(68px + 80px + env(safe-area-inset-bottom));
    }

    /* Bottom Navigation - Floating Rounded Style */
    .bottom-nav {
      position: fixed;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      width: min(480px, calc(100% - 32px));
      height: 68px;
      padding: 8px 12px calc(8px + env(safe-area-inset-bottom));
      display: flex;
      background: linear-gradient(180deg, var(--card), var(--card-2));
      backdrop-filter: saturate(180%) blur(20px);
      border-radius: 24px;
      border: 1px solid color-mix(in oklab, var(--text) 12%, transparent);
      box-shadow: 0 8px 32px rgba(0, 0, 0, .3), 0 0 0 1px rgba(255, 255, 255, .08) inset;
      z-index: 1000;
    }
    .nav-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      color: var(--muted);
      text-decoration: none;
      font-size: 11px;
      font-weight: 600;
      padding: 8px 4px;
      border-radius: 16px;
      transition: all .25s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }
    .nav-item:hover {
      color: var(--text);
      background: rgba(255, 255, 255, .06);
    }
    .nav-item.active {
      color: var(--primary);
      background: color-mix(in oklab, var(--primary) 12%, transparent);
    }
    .nav-item svg {
      width: 24px;
      height: 24px;
      transition: transform .25s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .nav-item:active svg {
      transform: scale(0.85);
    }

    .weather-card{
      grid-column: 1 / -1;
      padding: 20px;
      border-radius: 20px;
      color: #fff;
      display: flex;
      flex-direction: column;
      gap: 10px;
      background: linear-gradient(145deg, #667aff, #5ad4ff);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      transition: background .4s ease;
      width:min(1100px,92vw); 
      margin:18px auto 28px;
    }

    .wc-top{
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    .wc-temp{
      font-size:48px;
      font-weight:800;
    }

    .wc-desc{
      font-size:18px;
      font-weight:600;
      opacity:.9;
    }

    .wc-bottom{
      display:flex;
      justify-content:flex-start;
      gap:20px;
      font-size:15px;
      font-weight:600;
      margin-top:5px;
    }

    .wc-item{
      opacity:.9;
    }

    .wc-comment{
      margin-top:10px;
      font-size:14px;
      line-height:1.4;
      opacity:.95;
    }

    /* ê·¸ë¼ë””ì–¸íŠ¸ í…Œë§ˆ í”„ë¦¬ì…‹ */
    .weather-clear{
      background: linear-gradient(145deg, #ffb75e, #ff7c7c);
    }

    .weather-cloudy{
      background: linear-gradient(145deg, #8e9eab, #eef2f3);
      color:#0b0f14;
    }

    .weather-rain{
      background: linear-gradient(145deg, #4e54c8, #8f94fb);
    }

    .weather-snow{
      background: linear-gradient(145deg, #b6fbff, #83a4d4);
      color:#0b0f14;
    }

    /* Vote buttons */
    .vote-btn:hover {
      transform: scale(1.05);
      border-color: color-mix(in oklab, var(--primary) 50%, transparent);
    }
    .vote-btn:active {
      transform: scale(0.95);
    }
    .vote-btn.selected {
      background: color-mix(in oklab, var(--primary) 15%, transparent);
      border-color: var(--primary);
      box-shadow: 0 0 0 3px color-mix(in oklab, var(--primary) 20%, transparent);
    }

    /* Calendar styles */
    .calendar-grid {
      display: grid;
      gap: 10px;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    }
    .calendar-event {
      padding: 12px;
      border-radius: 12px;
      border: 1px solid color-mix(in oklab, var(--text) 12%, transparent);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      transition: all .2s ease;
    }
    .calendar-event:hover {
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.08));
      border-color: color-mix(in oklab, var(--primary) 30%, transparent);
    }
    .calendar-event.past {
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border-color: color-mix(in oklab, var(--text) 8%, transparent);
      color: var(--muted);
      opacity: .75;
    }
    .event-date {
      font-size: 12px;
      color: var(--primary);
      font-weight: 700;
      margin-bottom: 4px;
    }
    .calendar-event.past .event-date,
    .calendar-event.past .event-title,
    .calendar-event.past .event-description {
      color: var(--muted);
      text-decoration: line-through;
      text-decoration-thickness: 1px;
      text-decoration-color: color-mix(in oklab, var(--muted) 90%, transparent);
    }
    .event-title {
      font-weight: 700;
      font-size: 15px;
      margin-bottom: 4px;
    }
    .event-description {
      font-size: 13px;
      color: var(--muted);
      line-height: 1.4;
    }
    .event-actions {
      margin-top: 8px;
      display: flex;
      gap: 6px;
    }
    .event-btn {
      font-size: 11px;
      padding: 4px 10px;
      height: auto;
      border-radius: 8px;
    }

    /* Countdown controls */
    .countdown-controls {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    .countdown-controls input[type="date"],
    .countdown-controls input[type="time"] {
      height: 36px;
      padding: 0 12px;
      border-radius: 12px;
      border: 1px solid color-mix(in oklab, var(--text) 15%, transparent);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      color: var(--text);
      font-weight: 600;
      font-size: 14px;
      flex: 1;
      min-width: 120px;
    }
    .countdown-controls input[type="date"]::-webkit-calendar-picker-indicator,
    .countdown-controls input[type="time"]::-webkit-calendar-picker-indicator {
      filter: invert(1);
      cursor: pointer;
    }
    @media (prefers-color-scheme: light) {
      :root:not([data-theme="dark"]) .countdown-controls input[type="date"]::-webkit-calendar-picker-indicator,
      :root:not([data-theme="dark"]) .countdown-controls input[type="time"]::-webkit-calendar-picker-indicator {
        filter: invert(0);
      }
    }
    :root[data-theme="light"] .countdown-controls input[type="date"]::-webkit-calendar-picker-indicator,
    :root[data-theme="light"] .countdown-controls input[type="time"]::-webkit-calendar-picker-indicator {
      filter: invert(0);
    }
    @media (max-width: 600px) {
      .countdown-controls {
        width: 100%;
      }
      .countdown-controls input[type="date"],
      .countdown-controls input[type="time"] {
        flex: 1 1 calc(50% - 4px);
        min-width: 0;
      }
      .countdown-controls button {
        flex: 1 1 calc(50% - 4px);
      }
    }
  </style>
</head>
<body>
<div class="blob-container" aria-hidden="true">
  <div class="blob b1"></div>
  <div class="blob b2"></div>
  <div class="blob b3"></div>
</div>

<header>
  <div class="toolbar">
    <!--      <div class="title"><span class="dot" aria-hidden="true"></span>í•™êµ ìƒí™œ</div>-->
    <div class="controls">
      <label for="gradeSel" class="sr-only">í•™ë…„</label>
      <select id="gradeSel" aria-label="í•™ë…„ ì„ íƒ"></select>
      <label for="classSel" class="sr-only">ë°˜</label>
      <select id="classSel" aria-label="ë°˜ ì„ íƒ"></select>
      <button id="refreshBtn" class="ghost" type="button">â†»</button>
      <button id="weeklyBtn" class="cta" type="button">ì£¼ê°„</button>
    </div>
  </div>
</header>

<!-- ì˜¤ëŠ˜ ë‚ ì”¨ ì¹´ë“œ -->
<section class="weather-card fade-up" id="weatherCard">
  <div class="wc-top">
    <div class="wc-temp" id="wcTemp">--Â°</div>
    <div class="wc-desc" id="wcDesc">ë‚ ì”¨ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>
  </div>
  <div class="wc-bottom">
    <div class="wc-item"><span id="wcHigh">--Â°</span> / <span id="wcLow">--Â°</span></div>
    <div class="wc-item" id="wcRain">ê°•ìˆ˜í™•ë¥  --%</div>
  </div>
  <div class="wc-comment" id="wcComment">ì˜¤ëŠ˜ ë‚ ì”¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>
</section>

<main>
  <!-- ì™¼ìª½: ì˜¤ëŠ˜ ì‹œê°„í‘œ -->
  <section class="panel fade-up" style="--area:left" aria-labelledby="tt-h">
    <!-- <div class="time" id="nowClock">&#45;&#45;:&#45;&#45;:&#45;&#45;</div> -->
    <div class="head">
      <h2 id="tt-h">ì˜¤ëŠ˜ ì‹œê°„í‘œ</h2>
      <div class="sub" id="tt-sub"></div>
    </div>
    <div id="timetableToday" class="list" role="list"></div>
  </section>

  <!-- ì˜¤ë¥¸ìª½: ì˜¤ëŠ˜ ê¸‰ì‹ -->
  <section class="panel fade-up" style="--area:right" aria-labelledby="meal-h">
    <div class="head">
      <h2 id="meal-h">ì˜¤ëŠ˜ ê¸‰ì‹</h2>
      <div class="sub" id="meal-sub"></div>
    </div>
    <div class="meal-grid" id="mealGrid">
      <div class="meal-card"><h3>ì•„ì¹¨</h3><div class="empty">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div></div>
      <div class="meal-card"><h3>ì ì‹¬</h3><div class="empty">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div></div>
      <div class="meal-card"><h3>ì €ë…</h3><div class="empty">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div></div>
    </div>

    <!-- ê¸‰ì‹ íˆ¬í‘œ -->
    <div style="margin-top:16px; padding:14px; border-radius:14px; background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03)); border:1px solid color-mix(in oklab, var(--text) 10%, transparent);">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:8px;">
        <div style="font-weight:600; font-size:14px;">ì˜¤ëŠ˜ ê¸‰ì‹ ì–´ë•Œìš”?</div>
        <div style="display:flex; gap:8px;">
          <button id="mealThumbsUp" class="vote-btn" style="font-size:24px; background:transparent; border:1px solid color-mix(in oklab, var(--text) 15%, transparent); border-radius:10px; padding:8px 12px; cursor:pointer; transition:all .2s;">ğŸ‘</button>
          <button id="mealThumbsDown" class="vote-btn" style="font-size:24px; background:transparent; border:1px solid color-mix(in oklab, var(--text) 15%, transparent); border-radius:10px; padding:8px 12px; cursor:pointer; transition:all .2s;">ğŸ‘</button>
        </div>
      </div>
      <div id="mealVoteStats" style="font-size:13px; color:var(--muted); text-align:center;">íˆ¬í‘œ ì •ë³´ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>
  </section>

  <!-- ê·€ê°€ ì¹´ìš´íŠ¸ë‹¤ìš´ -->
  <section class="panel fade-up" style="grid-column:1/-1; --area:countdown" aria-labelledby="countdown-h">
    <div class="head" style="flex-wrap:wrap;">
      <h2 id="countdown-h">ê·€ê°€ê¹Œì§€</h2>
      <div class="countdown-controls">
        <input type="date" id="homeDateInput" placeholder="ë‚ ì§œ">
        <input type="time" id="homeTimeOnlyInput" placeholder="ì‹œê°„">
        <button id="setHomeTimeBtn" class="cta" type="button">ì„¤ì •</button>
        <button id="clearHomeTimeBtn" class="ghost" type="button" style="height:36px; padding:0 12px; font-size:13px;">ì´ˆê¸°í™”</button>
      </div>
    </div>
    <div id="countdownDisplay" style="margin-top:16px; text-align:center; font-size:clamp(28px, 8vw, 48px); font-weight:800; color:var(--primary); min-height:60px; display:flex; align-items:center; justify-content:center;">
      ê·€ê°€ ì‹œê°„ì„ ì„¤ì •í•´ì£¼ì„¸ìš”
    </div>
    <div id="countdownMessage" style="margin-top:12px; text-align:center; font-size:clamp(13px, 3.5vw, 16px); color:var(--muted);"></div>
  </section>

  <!-- ë°˜ë³„ ê³µë™ ìº˜ë¦°ë” -->
  <section class="panel fade-up" style="grid-column:1/-1; --area:calendar" aria-labelledby="calendar-h">
    <div class="head">
      <h2 id="calendar-h">ë°˜ ìº˜ë¦°ë”</h2>
      <button id="addEventBtn" class="cta" style="height:36px; padding:0 16px; font-size:14px;" type="button">+ ì¼ì • ì¶”ê°€</button>
    </div>
    <div id="calendarView" style="margin-top:12px;">
      <!-- Calendar will be rendered here -->
    </div>
  </section>
</main>

<div class="spacer"></div>

<!-- ì£¼ê°„ ì‹œê°„í‘œ ëª¨ë‹¬ -->
<div class="modal-overlay" id="weeklyOverlay" hidden>
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="weeklyTitle">
    <div class="modal-head">
      <h3 class="modal-title" id="weeklyTitle">ì£¼ê°„ ì‹œê°„í‘œ</h3>
      <button class="modal-close" id="weeklyClose" aria-label="ë‹«ê¸°">Ã—</button>
    </div>
    <div id="weeklyContainer">
      <div class="sub" style="margin-bottom:8px">ë¡œë”© ì¤‘â€¦</div>
    </div>
  </div>
</div>
<script>
  // -------- util: clock --------
  // function updateClock(){
  //   const now=new Date();
  //   document.getElementById('nowClock').textContent =
  //     now.toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  // }
  // updateClock(); setInterval(updateClock, 1000);

  // -------- storage helpers (compat with etc.js keys) --------
  function saveData(key, value){
    try{
      if (value === undefined || value === null){
        localStorage.removeItem(key);
        return;
      }
      localStorage.setItem(key, JSON.stringify(value));
    }catch(err){
      console.warn('[storage] save failed', err);
    }
  }
  function loadData(key){
    try{
      const raw = localStorage.getItem(key);
      if (raw === null || raw === 'undefined'){
        return null;
      }
      try{
        return JSON.parse(raw);
      }catch(parseErr){
        return raw;
      }
    }catch(err){
      console.warn('[storage] load failed', err);
      return null;
    }
  }

  // -------- select init --------
  const gradeSel = document.getElementById('gradeSel');
  const classSel = document.getElementById('classSel');
  (function initSelectors(){
    for(let g=1; g<=3; g++){ const o=document.createElement('option'); o.value=String(g); o.textContent=`${g}í•™ë…„`; gradeSel.appendChild(o); }
    for(let c=1; c<=6; c++){ const o=document.createElement('option'); o.value=String(c); o.textContent=`${c}ë°˜`; classSel.appendChild(o); }
    gradeSel.value = loadData('last_grade') || '1';
    classSel.value  = loadData('last_class') || '3';
    gradeSel.addEventListener('change', onSelChange);
    classSel.addEventListener('change', onSelChange);
  })();

  function onSelChange(){
    saveData('last_grade', gradeSel.value);
    saveData('last_class', classSel.value);
    loadAllSchoollifeData();
  }

  // -------- API helpers --------
  async function fetchJson(url) {
    const response = await fetch(url);
    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
    return await response.json();
  }

  function applyWeatherGradient(desc){
    const card = document.getElementById('weatherCard');
    if (!card) return;
    const lower = (desc || '').toLowerCase();
    card.classList.remove('weather-clear','weather-cloudy','weather-rain','weather-snow');
    if (lower.includes('ë¹„') || lower.includes('rain')) {
      card.classList.add('weather-rain');
    } else if (lower.includes('ëˆˆ') || lower.includes('snow')) {
      card.classList.add('weather-snow');
    } else if (lower.includes('êµ¬ë¦„') || lower.includes('cloud') || lower.includes('íë¦¼')) {
      card.classList.add('weather-cloudy');
    } else {
      card.classList.add('weather-clear');
    }
  }

  function applyWeatherGradient(desc){
    const card = document.getElementById('weatherCard');
    if (!card) return;
    const lower = (desc || '').toLowerCase();
    card.classList.remove('weather-clear','weather-cloudy','weather-rain','weather-snow');
    if (lower.includes('ë¹„')) {
      card.classList.add('weather-rain');
    } else if (lower.includes('ëˆˆ')) {
      card.classList.add('weather-snow');
    } else if (lower.includes('êµ¬ë¦„') || lower.includes('íë¦¼') || lower.includes('cloud')) {
      card.classList.add('weather-cloudy');
    } else {
      card.classList.add('weather-clear');
    }
  }

  function renderWeather(data){
    const tempEl = document.getElementById('wcTemp');
    const descEl = document.getElementById('wcDesc');
    const highEl = document.getElementById('wcHigh');
    const lowEl = document.getElementById('wcLow');
    const rainEl = document.getElementById('wcRain');
    const temp = data?.temperature;
    const desc = data?.desc || 'ë‚ ì”¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
    if (tempEl) tempEl.textContent = temp != null ? `${Math.round(temp)}Â°` : '--Â°';
    if (descEl) descEl.textContent = desc;
    if (highEl) highEl.textContent = data?.high != null ? `${Math.round(data.high)}Â°` : '--Â°';
    if (lowEl) lowEl.textContent = data?.low != null ? `${Math.round(data.low)}Â°` : '--Â°';
    if (rainEl) rainEl.textContent = `ê°•ìˆ˜í™•ë¥  ${data?.rain != null ? data.rain : '--'}%`;
    applyWeatherGradient(desc);
  }

  // -------- timetable (based on etc.js NEIS example) --------
  const ATPT_OFCDC_SC_CODE='J10';     // ê²½ê¸°ë„êµìœ¡ì²­
  const SD_SCHUL_CODE='7530560';      // í•œêµ­ë””ì§€í„¸ë¯¸ë””ì–´ê³ 
  const API_KEY='da82433f0f3a4351bda4ca9a0f11fc7d'; // from etc.js sample

  function fmtYYYYMMDD(date){
    const y=date.getFullYear();
    const m=String(date.getMonth()+1).padStart(2,'0');
    const d=String(date.getDate()).padStart(2,'0');
    return `${y}${m}${d}`;
  }
  function fmtYYYY_MM_DD(date){
    const y=date.getFullYear();
    const m=String(date.getMonth()+1).padStart(2,'0');
    const d=String(date.getDate()).padStart(2,'0');
    return `${y}-${m}-${d}`;
  }
  function weekMonToFri(date=new Date()){
    const day = date.getDay(); // 0(ì¼)~6(í† )
    const diff = date.getDate() - day + (day===0 ? -6 : 1); // ì›”ìš”ì¼
    const monday = new Date(date); monday.setDate(diff); 
    return Array.from({length:5},(_,i)=>{const t=new Date(monday); t.setDate(monday.getDate()+i); return t;});
  }

  function timetableCacheKey(g,c,weekStart){ return `timetable_${g}_${c}_${weekStart}` }

  function normalizeSubject(r){
    return r.ITRT_CNTNT || r.SUBJECT || r.SUB_NM || '';
  }

  function fmtDateKR(dateStr) {
    if (!dateStr) return '';
    const date = new Date(dateStr);
    if (Number.isNaN(date.getTime())) return dateStr;
    const yoil = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '][date.getDay()];
    return `${date.getFullYear()}.${date.getMonth()+1}.${date.getDate()} (${yoil})`;
  }

  function buildWeatherComment(data){
    const temp = Number(data?.temperature);
    const high = Number(data?.high);
    const low = Number(data?.low);
    const rain = Number(data?.rain);
    const comments = [];

    if (!Number.isNaN(temp)) {
      if (temp <= -3) comments.push('ë‘êº¼ìš´ ì™¸íˆ¬ì™€ ì¥ê°‘ì´ í•„ìš”í•´ìš”.');
      else if (temp <= 5) comments.push('ì°¬ë°”ëŒì´ ë¶ˆì–´ìš”. ê²¹ê²¹ì´ ì…ìœ¼ì„¸ìš”.');
      else if (temp >= 28) comments.push('ë¬´ë”ìš´ ë‚ ì”¨, ìˆ˜ë¶„ ë³´ì¶© ìŠì§€ ë§ˆì„¸ìš”!');
      else if (temp >= 22) comments.push('í•œì—¬ë¦„ ê°™ì€ ë”ìœ„ì…ë‹ˆë‹¤. ì‹œì›í•œ ì˜·ì°¨ë¦¼ ì¶”ì²œ!');
    }

    if (!Number.isNaN(rain)) {
      if (rain >= 70) comments.push('ìš°ì‚° í•„ìˆ˜! ë¹„ ì˜¬ í™•ë¥ ì´ ë†’ì•„ìš”.');
      else if (rain >= 40) comments.push('ì†Œë‚˜ê¸°ê°€ ì˜¬ ìˆ˜ë„ ìˆìœ¼ë‹ˆ ìš°ì‚° í™•ì¸!');
      else if (rain <= 10) comments.push('ë¹„ ì†Œì‹ì€ ê±°ì˜ ì—†ì–´ìš”.');
    }

    if (!comments.length) {
      if (!Number.isNaN(high) && !Number.isNaN(low)) {
        comments.push(`ì˜¤ëŠ˜ ê¸°ì˜¨ ${Math.round(low)}Â° ~ ${Math.round(high)}Â° ì˜ˆì •ì…ë‹ˆë‹¤.`);
      } else {
        comments.push('ì¾Œì í•œ í•˜ë£¨ ë³´ë‚´ì„¸ìš”!');
      }
    }

    return comments.join(' ');
  }

  function renderWeather(data){
    const tempEl = document.getElementById('wcTemp');
    const descEl = document.getElementById('wcDesc');
    const highEl = document.getElementById('wcHigh');
    const lowEl = document.getElementById('wcLow');
    const rainEl = document.getElementById('wcRain');
    const commentEl = document.getElementById('wcComment');
    const temp = data?.temperature;
    const desc = data?.desc || 'ë‚ ì”¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
    if (tempEl) tempEl.textContent = temp != null ? `${Math.round(temp)}Â°` : '--Â°';
    if (descEl) descEl.textContent = desc;
    if (highEl) highEl.textContent = data?.high != null ? `${Math.round(data.high)}Â°` : '--Â°';
    if (lowEl) lowEl.textContent = data?.low != null ? `${Math.round(data.low)}Â°` : '--Â°';
    if (rainEl) rainEl.textContent = `ê°•ìˆ˜í™•ë¥  ${data?.rain != null ? data.rain : '--'}%`;
    if (commentEl) commentEl.textContent = buildWeatherComment(data);
    applyWeatherGradient(desc);
  }

  function showWeatherError(message){
    console.error('[Schoollife] weather load failed:', message);
    const fallback = {
      temperature: null,
      desc: 'ë‚ ì”¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
      high: null,
      low: null,
      rain: null,
    };
    renderWeather(fallback);
    const commentEl = document.getElementById('wcComment');
    if (commentEl) {
      commentEl.textContent = 'ë‚ ì”¨ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.';
    }
  }

  // Remove old timetable fetching logic; server supplies data
  function renderTimetable(payload){
    const list = document.getElementById('timetableToday');
    const sub  = document.getElementById('tt-sub');
    list.innerHTML = '';

    const lessons = payload?.lessons || [];
    sub.textContent = fmtDateKR(payload?.date) || 'ì˜¤ëŠ˜ ì‹œê°„í‘œ';

    if (!lessons.length) {
      list.innerHTML = `<div class="empty">ì‹œê°„í‘œë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</div>`;
      return;
    }

    lessons.forEach(item => {
      const period = item.period ? `${item.period}êµì‹œ` : 'ìˆ˜ì—…';
      const subject = item.subject || 'ë¯¸ìƒ';
      const teacher = item.teacher ? `(${item.teacher})` : '';
      const div = document.createElement('div');
      div.className='row';
      div.innerHTML = `
        <div class="period">${period}</div>
        <div>
          <div class="subject">${subject}</div>
          <div class="sub">${teacher}</div>
        </div>`;
      list.appendChild(div);
    });
  }

  // -------- weekly modal render --------
  function openWeekly(wrapped){
    const ov = document.getElementById('weeklyOverlay');
    const cont = document.getElementById('weeklyContainer');
    ov.hidden=false; requestAnimationFrame(()=>ov.classList.add('visible'));

    const days=['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ'];
    const maxP=7;

    let html = '<table><thead><tr><th>êµì‹œ</th>';
    for(const d of days) html += `<th>${d}</th>`;
    html += '</tr></thead><tbody>';

    for(let p=1;p<=maxP;p++){
      html += `<tr><td>${p}</td>`;
      for(let di=0; di<5; di++){
        const rowList = (wrapped.data[di]||[]).filter(x=>Number(x.PERIO)===p);
        const cell = rowList.length
          ? Array.from(new Set(rowList.map(x=>normalizeSubject(x)).filter(Boolean))).join('<br>')
          : '';
        html += `<td>${cell}</td>`;
      }
      html += '</tr>';
    }
    html += '</tbody></table>';

    cont.innerHTML = html;
  }
  document.getElementById('weeklyClose').addEventListener('click', closeWeekly);
  document.getElementById('weeklyOverlay').addEventListener('click', (e)=>{ if(e.target.id==='weeklyOverlay') closeWeekly(); });
  function closeWeekly(){
    const ov = document.getElementById('weeklyOverlay');
    ov.classList.remove('visible');
    ov.addEventListener('transitionend', ()=>{ ov.hidden=true; }, { once:true });
  }

  // -------- meal (based on etc.js example) --------
  function getTodayDateStringDash(){ return fmtYYYY_MM_DD(new Date()); }
  // Remove old external meal fetcher
  function renderMeal(data){
    const grid = document.getElementById('mealGrid');
    const sub = document.getElementById('meal-sub');
    if (sub) sub.textContent = (data?.date || '').replace(/-/g,'.');

    const entries = [
      {title:'ì•„ì¹¨', text:data?.breakfast},
      {title:'ì ì‹¬', text:data?.lunch},
      {title:'ì €ë…', text:data?.dinner},
    ];
    grid.innerHTML = '';
    for(const {title,text} of entries){
      const card = document.createElement('div');
      card.className='meal-card';
      if (text) {
        const items = text.split('\n').filter(Boolean).map(s=>`<li>${s.replace(/\*|\./g,'').trim()}</li>`).join('');
        card.innerHTML = `<h3>${title}</h3><ul>${items}</ul>`;
      } else {
        card.innerHTML = `<h3>${title}</h3><div class="empty">ì •ë³´ ì—†ìŒ</div>`;
      }
      grid.appendChild(card);
    }
  }

  function showMealError(message){
    console.error('[Schoollife] meal load failed:', message);
    const grid = document.getElementById('mealGrid');
    const sub = document.getElementById('meal-sub');
    if (sub) sub.textContent = 'ê¸‰ì‹ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
    if (grid) {
      grid.innerHTML = '<div class="meal-card"><h3>ì•Œë¦¼</h3><div class="empty">ê¸‰ì‹ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.</div></div>';
    }
  }

  function showTimetableError(message){
    console.error('[Schoollife] timetable load failed:', message);
    const list = document.getElementById('timetableToday');
    if (list) {
      list.innerHTML = '<div class="empty">ì‹œê°„í‘œë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.<br>ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.</div>';
    }
  }

  // -------- load all --------
  async function loadTodayAll(){
    const list = document.getElementById('timetableToday');
    list.innerHTML = '<div class="empty">ì‹œê°„í‘œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</div>';
    const g = gradeSel.value, c = classSel.value;
    try {
      const [weatherResult, mealResult, timetableResult] = await Promise.allSettled([
        fetchJson('/api/classes/schoollife/weather'),
        fetchJson('/api/classes/schoollife/meal'),
        fetchJson(`/api/classes/schoollife/timetable?grade=${g}&section=${c}`)
      ]);

      if (weatherResult.status === 'fulfilled') {
        renderWeather(weatherResult.value);
      } else {
        showWeatherError(weatherResult.reason);
      }

      if (mealResult.status === 'fulfilled') {
        renderMeal(mealResult.value);
      } else {
        showMealError(mealResult.reason);
      }

      if (timetableResult.status === 'fulfilled') {
        renderTimetable(timetableResult.value);
      } else {
        showTimetableError(timetableResult.reason);
      }
    } catch(e) {
      console.error("loadTodayAll error:", e);
      showWeatherError(e);
      showMealError(e);
      showTimetableError(e);
    }
  }

  document.getElementById('refreshBtn').addEventListener('click', loadAllSchoollifeData);

  // -------- Meal Vote --------
  async function loadMealVoteStats(){
    const g = gradeSel.value, c = classSel.value;
    try {
      const res = await fetchJson(`/api/classes/schoollife/meal/stats?grade=${g}&section=${c}`);
      const statsEl = document.getElementById('mealVoteStats');
      const thumbsUpBtn = document.getElementById('mealThumbsUp');
      const thumbsDownBtn = document.getElementById('mealThumbsDown');

      // Clear selection
      thumbsUpBtn.classList.remove('selected');
      thumbsDownBtn.classList.remove('selected');

      // Show stats
      if (res.totalCount === 0) {
        statsEl.textContent = 'ì•„ì§ íˆ¬í‘œí•œ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤';
      } else {
        statsEl.textContent = `ìš°ë¦¬ í•™êµ í•™ìƒì˜ ${res.percentage}%ê°€ ë§›ìˆë‹¤ê³  í‘œì‹œí–ˆì–´ìš” (${res.positiveCount}/${res.totalCount}ëª…)`;
      }

      // Highlight user's vote
      if (res.myVote === true) {
        thumbsUpBtn.classList.add('selected');
      } else if (res.myVote === false) {
        thumbsDownBtn.classList.add('selected');
      }
    } catch(e) {
      console.error('Failed to load meal vote stats:', e);
      document.getElementById('mealVoteStats').textContent = 'íˆ¬í‘œ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
    }
  }

  async function voteMeal(isPositive){
    const g = gradeSel.value, c = classSel.value;
    try {
      await fetch(`/api/classes/schoollife/meal/vote?grade=${g}&section=${c}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({isPositive})
      });
      await loadMealVoteStats();
    } catch(e) {
      console.error('Failed to vote:', e);
      alert('íˆ¬í‘œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
    }
  }

  document.getElementById('mealThumbsUp').addEventListener('click', () => voteMeal(true));
  document.getElementById('mealThumbsDown').addEventListener('click', () => voteMeal(false));

  // -------- Calendar --------
  let calendarEvents = [];

  async function loadCalendarEvents(){
    const g = gradeSel.value, c = classSel.value;
    try {
      const res = await fetchJson(`/api/classes/calendar/events?grade=${g}&section=${c}`);
      calendarEvents = res.events || [];
      renderCalendar();
    } catch(e) {
      console.error('Failed to load calendar events:', e);
      document.getElementById('calendarView').innerHTML = '<div class="empty">ìº˜ë¦°ë”ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>';
    }
  }

  function renderCalendar(){
    const container = document.getElementById('calendarView');
    if (calendarEvents.length === 0) {
      container.innerHTML = '<div class="empty">ì•„ì§ ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤</div>';
      return;
    }

    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const currentMonthStart = new Date(today.getFullYear(), today.getMonth(), 1);

    // Group upcoming events by month (exclude past months)
    const grouped = {};
    calendarEvents.forEach(event => {
      const dateObj = new Date(event.date);
      if (Number.isNaN(dateObj.getTime()) || dateObj < currentMonthStart) {
        return;
      }
      const monthKey = `${dateObj.getFullYear()}-${String(dateObj.getMonth()+1).padStart(2,'0')}`;
      if (!grouped[monthKey]) grouped[monthKey] = [];
      grouped[monthKey].push({...event, dateObj});
    });

    const monthKeys = Object.keys(grouped).sort();
    if (monthKeys.length === 0) {
      container.innerHTML = '<div class="empty">ë‹¤ê°€ì˜¤ëŠ” ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤</div>';
      return;
    }

    const dayNames = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
    let html = '';
    monthKeys.forEach(monthKey => {
      const [year, month] = monthKey.split('-');
      html += `<div style="margin-bottom:20px;">`;
      html += `<h3 style="font-size:16px; margin:0 0 10px; color:var(--primary);">${year}ë…„ ${parseInt(month, 10)}ì›”</h3>`;
      html += `<div class="calendar-grid">`;

      grouped[monthKey]
        .sort((a, b) => a.dateObj - b.dateObj)
        .forEach(event => {
          const dateStr = `${event.dateObj.getMonth()+1}/${event.dateObj.getDate()} (${dayNames[event.dateObj.getDay()]})`;
          const isPast = event.dateObj < today;

          html += `<div class="calendar-event${isPast ? ' past' : ''}" data-event-id="${event.id}">`;
          html += `<div class="event-date">${dateStr}</div>`;
          html += `<div class="event-title">${escapeHtml(event.title)}</div>`;
          if (event.description) {
            html += `<div class="event-description">${escapeHtml(event.description)}</div>`;
          }
          html += `<div class="event-actions">`;
          html += `<button class="event-btn ghost" onclick="editEvent(${event.id})">ìˆ˜ì •</button>`;
          html += `<button class="event-btn ghost" onclick="deleteEvent(${event.id})">ì‚­ì œ</button>`;
          html += `</div>`;
          html += `</div>`;
        });

      html += `</div></div>`;
    });

    container.innerHTML = html;
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  window.editEvent = async function(eventId) {
    const event = calendarEvents.find(e => e.id === eventId);
    if (!event) return;

    const title = prompt('ì¼ì • ì œëª©:', event.title);
    if (title === null) return;
    if (!title.trim()) {
      alert('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
      return;
    }

    const description = prompt('ì¼ì • ì„¤ëª… (ì„ íƒ):', event.description || '');
    const dateStr = prompt('ë‚ ì§œ (YYYY-MM-DD):', event.date);
    if (!dateStr) return;

    try {
      await fetch(`/api/classes/calendar/events/${eventId}`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          title: title.trim(),
          description: description ? description.trim() : '',
          date: dateStr
        })
      });
      await loadCalendarEvents();
    } catch(e) {
      console.error('Failed to update event:', e);
      alert('ì¼ì • ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
    }
  };

  window.deleteEvent = async function(eventId) {
    if (!confirm('ì´ ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    try {
      await fetch(`/api/classes/calendar/events/${eventId}`, {
        method: 'DELETE'
      });
      await loadCalendarEvents();
    } catch(e) {
      console.error('Failed to delete event:', e);
      alert('ì¼ì • ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
    }
  };

  document.getElementById('addEventBtn').addEventListener('click', async () => {
    const title = prompt('ì¼ì • ì œëª©:');
    if (!title || !title.trim()) return;

    const description = prompt('ì¼ì • ì„¤ëª… (ì„ íƒ):');
    const dateStr = prompt('ë‚ ì§œ (YYYY-MM-DD):', new Date().toISOString().split('T')[0]);
    if (!dateStr) return;

    const g = gradeSel.value, c = classSel.value;
    try {
      await fetch(`/api/classes/calendar/events?grade=${g}&section=${c}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          title: title.trim(),
          description: description ? description.trim() : '',
          date: dateStr
        })
      });
      await loadCalendarEvents();
    } catch(e) {
      console.error('Failed to create event:', e);
      alert('ì¼ì • ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤');
    }
  });

  // -------- Countdown Timer --------
  let countdownInterval = null;

  function parseSavedHomeTime(raw){
    if (!raw && raw !== 0){
      return null;
    }
    if (typeof raw === 'number'){
      const byNumber = new Date(raw);
      return Number.isNaN(byNumber.getTime()) ? null : byNumber;
    }
    const parsed = new Date(String(raw));
    return Number.isNaN(parsed.getTime()) ? null : parsed;
  }

  function formatDateInputValue(date){
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, '0');
    const d = String(date.getDate()).padStart(2, '0');
    return `${y}-${m}-${d}`;
  }

  function formatTimeInputValue(date){
    const h = String(date.getHours()).padStart(2, '0');
    const m = String(date.getMinutes()).padStart(2, '0');
    return `${h}:${m}`;
  }

  function updateCountdown() {
    const targetDate = parseSavedHomeTime(loadData('homeTime'));
    if (!targetDate) {
      document.getElementById('countdownDisplay').textContent = 'ê·€ê°€ ì‹œê°„ì„ ì„¤ì •í•´ì£¼ì„¸ìš”';
      document.getElementById('countdownMessage').textContent = '';
      return;
    }

    const now = new Date();
    const diff = targetDate - now;

    if (diff <= 0) {
      document.getElementById('countdownDisplay').textContent = 'ğŸ‰ ì§‘ì— ê°€ëŠ” ì‹œê°„ì…ë‹ˆë‹¤!';
      document.getElementById('countdownMessage').textContent = 'ì•ˆì „í•˜ê²Œ ê·€ê°€í•˜ì„¸ìš”';
      if (countdownInterval) {
        clearInterval(countdownInterval);
        countdownInterval = null;
      }
      return;
    }

    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((diff % (1000 * 60)) / 1000);

    let displayText = '';
    if (days > 0) {
      displayText = `${days}ì¼ ${hours}ì‹œê°„ ${minutes}ë¶„ ${seconds}ì´ˆ`;
    } else if (hours > 0) {
      displayText = `${hours}ì‹œê°„ ${minutes}ë¶„ ${seconds}ì´ˆ`;
    } else if (minutes > 0) {
      displayText = `${minutes}ë¶„ ${seconds}ì´ˆ`;
    } else {
      displayText = `${seconds}ì´ˆ`;
    }

    document.getElementById('countdownDisplay').textContent = displayText;

    const dateStr = targetDate.toLocaleDateString('ko-KR', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      weekday: 'short'
    });
    const timeStr = targetDate.toLocaleTimeString('ko-KR', {
      hour: '2-digit',
      minute: '2-digit'
    });
    document.getElementById('countdownMessage').textContent = `ëª©í‘œ: ${dateStr} ${timeStr}`;
  }

  function startCountdown() {
    if (countdownInterval) {
      clearInterval(countdownInterval);
    }
    updateCountdown();
    countdownInterval = setInterval(updateCountdown, 1000);
  }

  document.getElementById('setHomeTimeBtn').addEventListener('click', () => {
    const dateInput = document.getElementById('homeDateInput');
    const timeInput = document.getElementById('homeTimeOnlyInput');
    const dateValue = dateInput.value;
    const timeValue = timeInput.value;

    if (!dateValue || !timeValue) {
      alert('ë‚ ì§œì™€ ì‹œê°„ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”');
      return;
    }

    const targetDate = new Date(`${dateValue}T${timeValue}:00`);
    const now = new Date();

    if (targetDate <= now) {
      alert('ë¯¸ë˜ì˜ ë‚ ì§œì™€ ì‹œê°„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”');
      return;
    }

    saveData('homeTime', targetDate.toISOString());
    startCountdown();
  });

  document.getElementById('clearHomeTimeBtn').addEventListener('click', () => {
    if (confirm('ê·€ê°€ ì‹œê°„ ì„¤ì •ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
      saveData('homeTime', null);
      document.getElementById('homeDateInput').value = '';
      document.getElementById('homeTimeOnlyInput').value = '';
      document.getElementById('countdownDisplay').textContent = 'ê·€ê°€ ì‹œê°„ì„ ì„¤ì •í•´ì£¼ì„¸ìš”';
      document.getElementById('countdownMessage').textContent = '';
      if (countdownInterval) {
        clearInterval(countdownInterval);
        countdownInterval = null;
      }
    }
  });

  // Load saved countdown time on page load
  function initCountdown() {
    const savedTime = parseSavedHomeTime(loadData('homeTime'));
    if (savedTime) {
      document.getElementById('homeDateInput').value = formatDateInputValue(savedTime);
      document.getElementById('homeTimeOnlyInput').value = formatTimeInputValue(savedTime);
      startCountdown();
    }
  }

  // -------- Load all data --------
  async function loadAllSchoollifeData() {
    // Load all data in parallel for better performance
    await Promise.all([
      loadTodayAll(),
      loadMealVoteStats(),
      loadCalendarEvents()
    ]);
  }

  // initial kick
  loadAllSchoollifeData();
  initCountdown();
</script>

<nav class="bottom-nav" aria-label="í•˜ë‹¨ ë‚´ë¹„ê²Œì´ì…˜">
  <a href="/schoollife.html" class="nav-item active" aria-current="page">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 3 1 9l4 2.18v6.32L12 21l7-3.5V11.18L23 9 12 3zm0 2.69L17.53 9 12 11.31 6.47 9 12 5.69zM18 17.18l-5 2.5v-5.81l5-2.5v5.81z"/></svg>
    <span>í•™êµìƒí™œ</span>
  </a>
  <a href="/routine.html" class="nav-item">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M7 2a1 1 0 0 1 1 1v1h8V3a1 1 0 1 1 2 0v1h1a3 3 0 0 1 3 3v11a3 3 0 0 1-3 3H4a3 3 0 0 1-3-3V7a3 3 0 0 1 3-3h1V3a1 1 0 0 1 1-1Zm13 8H4v9a1 1 0 0 0 1 1h14a1 1 0 0 0 1-1v-9ZM6 7h12V6H6v1Z"/></svg>
    <span>ë£¨í‹´</span>
  </a>
  <a href="/user.html" class="nav-item">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
    <span>í™ˆ</span>
  </a>
  <a href="/chat.html" class="nav-item">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>
    <span>ì±„íŒ…</span>
  </a>
  <a href="/my.html" class="nav-item">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5zm0 2c-3.33 0-10 1.67-10 5v3h20v-3c0-3.33-6.67-5-10-5z"/></svg>
    <span>ë§ˆì´</span>
  </a>
</nav>
</body>
</html>
