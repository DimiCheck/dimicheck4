<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <meta name="theme-color" content="#0b0f14"/>
  <meta name="application-name" content="DIMI Check"/>
  <meta name="mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <link rel="manifest" href="/manifest.webmanifest">
  <script defer src="/js/pwa.js"></script>
  <title>DIMI Check</title>
  <meta name="color-scheme" content="light dark" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script defer data-domain="chec.kro.kr" src="https://plausible.io/js/script.js"></script>
  <link rel="apple-touch-icon" sizes="180x180" href="src/favicon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="src/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="src/favicon/favicon-16x16.png">
<style>
    :root{
      --bg: #0b0f14;
      --bg-2: #0e1218;
      --card: rgba(255,255,255,.08);
      --card-2: rgba(255,255,255,.06);
      --text: #e9eef6;
      --muted: #a7b0c0;
      --primary: #d04fff;
      --primary-2: #ff6ad0;
      --ring: 0 0 0 8px color-mix(in oklab, var(--primary) 30%, transparent);
      --shadow: 0 10px 30px rgba(0, 0, 0, .45);
      --radius: 20px;
    }
    @media (prefers-color-scheme: light) {
      :root {
        --bg: #f6f8fb;
        --bg-2: #eef2f8;
        --card: rgba(255,255,255,.75);
        --card-2: rgba(255,255,255,.6);
        --text: #0f172a;
        --muted: #5b6475;
        --primary: #d04fff;
        --primary-2: #ff6ad0;
        --shadow: 0 10px 30px rgba(57,72,103,.15);
      }
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:"Pretendard",system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,sans-serif;
      color:var(--text);
      background:var(--bg);
      display:grid;
      place-items:center;
      overflow:auto;
    }

    /* background blobs */
    .blob-container{
      position:fixed; inset:0; overflow:hidden; z-index:-1;
      background: radial-gradient(1200px 800px at 10% -10%, #5a6cff20, transparent 60%),
                  radial-gradient(1200px 800px at 110% 10%, #ff009025, transparent 60%),
                  radial-gradient(1000px 700px at 50% 120%, #ff00b325, transparent 60%);
    }
    .blob{position:absolute; filter:blur(40px); opacity:.6; pointer-events:none}
    .b1{width:48vw;height:48vw;background:radial-gradient(circle,#ff6a6a60,transparent 70%); top:-10vh; left:-10vw; animation:float 18s ease-in-out infinite}
    .b2{width:42vw;height:42vw;background:radial-gradient(circle,#e100ff50,transparent 70%); bottom:-15vh; right:-10vw; animation:float 22s ease-in-out infinite reverse}
    .b3{width:36vw;height:36vw;background:radial-gradient(circle,#ff6ae950,transparent 70%); top:40vh; left:10vw; animation:float 26s ease-in-out infinite}
    @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-20px)}}

    /* shell layout */
    .shell{
      position:relative;
      width:min(1100px,92vw);
      height:min(720px,92vh);
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      grid-template-areas:'main side';
      gap:18px; padding:18px; z-index:1;
    }
    @media (max-width: 1024px){
      .shell{grid-template-columns:1fr; grid-template-areas:'main' 'side'; height:auto}
    }

    .panel{
      position:relative; overflow:clip; border-radius:var(--radius);
      background:linear-gradient(180deg,var(--card),var(--card-2));
      backdrop-filter:saturate(140%) blur(14px);
      box-shadow:var(--shadow);
    }

    /* left: main interactions */
    .main{grid-area:main; display:grid; grid-template-rows:auto auto 1fr auto; gap:14px; padding:24px}
    .bar{
      display:flex; justify-content:space-between; align-items:center; gap:12px;
    }
    .who{
      display:flex; align-items:center; gap:12px;
    }
    .dot{width:10px;height:10px;border-radius:50%; background: #3ae374; box-shadow:0 0 10px #3ae37480}
    .who .name{font-weight:700}
    .who .meta{color:var(--muted); font-size:13px}

    .now{
      padding:16px;
      border:1px solid color-mix(in oklab, var(--text) 12%, transparent);
      border-radius:calc(var(--radius) + 4px);
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
    }
    .now h3{margin:0 0 6px; font-size:16px; letter-spacing:.2px}
    .now .val{font-size:28px; font-weight:700; line-height:1.2}

    .section-head{
      margin-top:6px; font-size:15px; color:var(--muted); letter-spacing:.5px
    }

    .grid{
      display:grid; grid-template-columns:repeat(2, 1fr); gap:14px; margin-top:8px;
    }
    @media (max-width:700px){ .grid{grid-template-columns:1fr} }

    .status-card{
      cursor:pointer; position:relative; padding:16px 16px 18px;
      border-radius:16px; border:1px solid color-mix(in oklab, var(--text) 12%, transparent);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      transition:transform .15s ease, box-shadow .2s ease, border-color .2s ease, background .2s ease;
    }
    .status-card:hover{transform:translateY(-1px)}
    .status-card.selected{
      transform:translateY(-2px);
      box-shadow:var(--ring);
      border-color: color-mix(in oklab, var(--primary) 50%, transparent);
      background:linear-gradient(180deg, color-mix(in oklab, var(--primary) 10%, rgba(255,255,255,.1)), rgba(255,255,255,.05));
    }
    .status-card.selected.completed{
      box-shadow:0 0 0 8px color-mix(in oklab, #38d67a 28%, transparent);
      border-color: color-mix(in oklab, #38d67a 45%, transparent);
    }
    .status-label{font-weight:800; letter-spacing:.2px; margin-bottom:6px}
    .status-desc{color:var(--muted); font-size:13px}

    .etc-box{ display:none; gap:10px; margin-top:12px; flex-wrap:wrap }
    .etc-row{ display:flex; gap:10px; width:100% }
    .input{
      width:100%; height:44px; padding:0 14px; border-radius:12px; outline:none; font-size:14px; color:var(--text);
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      border:1px solid color-mix(in oklab, var(--text) 18%, transparent);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.08);
    }
    .chip-list{display:flex; flex-wrap:wrap; gap:8px}
    .chip{
      display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px;
      border:1px solid color-mix(in oklab, var(--text) 18%, transparent);
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      font-size:13px;
    }
    .chip .del{
      background:transparent; border:0; color:var(--text); opacity:.7; cursor:pointer; font-size:18px; line-height:1; padding:0 4px;
    }
    .chip .del:hover{opacity:1}

    .btn{
      appearance:none; border:0; cursor:pointer; width:100%;
      display:flex; align-items:center; justify-content:center; gap:10px;
      padding:12px 14px; border-radius:12px; font-weight:700;
      color:#0b0f14; background:#fff; box-shadow:0 2px 0 rgba(0,0,0,.05);
      transition:transform .06s ease, box-shadow .2s ease;
    }
    .btn:active{transform:translateY(1px)}
    .btn.ghost{
      background:transparent; color:var(--text);
      border:1px solid color-mix(in oklab, var(--text) 12%, transparent); width:auto; padding:10px 12px;
    }
    .btn.cta{
      background:linear-gradient(135deg, var(--primary), var(--primary-2));
      color:#fff;
    }

    .submit-wrap{ margin-top:4px }
    .thought-trigger{
      display:flex;
      align-items:center;
      gap:6px;
    }
    .thought-trigger .btn{
      min-width:auto;
      padding:10px 12px;
    }
    .thought-overlay{
      position:fixed;
      inset:0;
      background:rgba(5,8,12,0.65);
      backdrop-filter:blur(12px);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
      z-index:2000;
    }
    .thought-overlay[hidden]{
      display:none !important;
    }
    .thought-dialog{
      width:min(420px, 100%);
      background:linear-gradient(180deg, rgba(20,24,32,0.92), rgba(14,18,26,0.96));
      border-radius:20px;
      border:1px solid rgba(255,255,255,0.08);
      box-shadow:0 20px 60px rgba(0,0,0,0.45);
      color:#f4f7ff;
      padding:24px;
      display:flex;
      flex-direction:column;
      gap:16px;
    }
    .thought-dialog h2{
      margin:0;
      font-size:20px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .thought-close{
      position:absolute;
      top:16px;
      right:16px;
      background:transparent;
      border:0;
      color:inherit;
      font-size:20px;
      cursor:pointer;
    }
    .thought-input{
      width:100%;
      min-height:100px;
      padding:12px 14px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(12,16,24,0.65);
      color:inherit;
      font-size:14px;
      resize:vertical;
      font-family:inherit;
      box-shadow:inset 0 2px 6px rgba(0,0,0,0.35);
    }
    .thought-input::placeholder{color:rgba(235,240,255,0.45)}
    .thought-actions{display:flex; gap:10px; flex-wrap:wrap}
    .thought-actions .btn{flex:1 1 auto}
    .thought-hint{font-size:12px; color:rgba(235,240,255,0.55)}
    .thought-feedback{min-height:1.2em; font-size:13px; color:rgba(235,240,255,0.55)}
    .thought-feedback.success{color:#58e08a}
    .thought-feedback.error{color:#ff8484}
    .footer{ text-align:center; color:var(--muted); font-size:12px; margin-top:10px }

    /* right: brand / time / illustration */
    .side{grid-area:side; display:grid; grid-template-rows:auto 1fr auto; padding:24px}
    .brand{display:flex; align-items:center; gap:12px; font-weight:800; letter-spacing:.2px}
    .logo{width:36px;height:36px;border-radius:12px;display:grid;place-items:center;color:#fff;box-shadow:inset 0 0 18px #ffffff40}
    .bigcopy{align-self:center; padding:12px 6px}
    .h1{font-size:clamp(24px,3.2vw,40px); font-weight:800; line-height:1.1; letter-spacing:-.02em; margin:0 0 10px}
    .p{margin:0; color:var(--muted); font-size:clamp(14px,1.7vw,16px)}
    .hero-cta{align-self:end; display:flex; gap:10px; flex-wrap:wrap}
    .chipx{
      border-radius:999px; padding:8px 12px;
      background:color-mix(in oklab, var(--card) 70%, rgba(255,255,255,.12));
      border:1px solid color-mix(in oklab, var(--text) 12%, transparent);
      font-size:.88rem; color:var(--muted)
    }
    .time{
      position:absolute; top:24px; right:24px; font-size:13px; color:var(--muted); letter-spacing:.5px
    }
    .illus{
      position:absolute; right:-6%; bottom:-6%; width:min(520px,60%); opacity:.9;
      filter:drop-shadow(0 14px 30px rgba(0,0,0,.25)); pointer-events:none;
    }

    /* Bottom Navigation */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: calc(60px + env(safe-area-inset-bottom));
      padding-bottom: env(safe-area-inset-bottom);
      display: flex;
      background: var(--card);
      backdrop-filter: saturate(140%) blur(14px);
      border-top: 1px solid color-mix(in oklab, var(--text) 10%, transparent);
      box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
      z-index: 1000;
    }
    .nav-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      color: var(--muted);
      text-decoration: none;
      font-size: 12px;
      font-weight: 500;
      transition: color .2s ease;
    }
    .nav-item:hover {
      color: var(--text);
    }
    .nav-item.active {
      color: var(--primary);
    }
    .nav-item svg {
      width: 24px;
      height: 24px;
    }

    .spacer {
      height: calc(60px + env(safe-area-inset-bottom));
    }

    @media (max-width:1024px){
      .illus{position:static; width:100%; margin-top:14px}
      .side{padding:20px}
    }

    /* motion */
    .fade-up{opacity:0; transform:translateY(10px); animation:rise .6s ease forwards}
    .fade-up:nth-child(1){animation-delay:.05s}
    .fade-up:nth-child(2){animation-delay:.12s}
    .fade-up:nth-child(3){animation-delay:.20s}
    .fade-up:nth-child(4){animation-delay:.28s}
    @keyframes rise{to{opacity:1; transform:none}}
    @media (prefers-reduced-motion: reduce){
      .blob{animation:none}
      .fade-up{opacity:1; transform:none; animation:none}
    }
  </style>
</head>

<body>
  <div class="blob-container" aria-hidden="true">
    <div class="blob b1"></div>
    <div class="blob b2"></div>
    <div class="blob b3"></div>
  </div>

  <main class="shell" role="main">
    <!-- LEFT: main interaction -->
    <section class="panel main" aria-label="ê°œì¸ ìƒíƒœ ê´€ë¦¬">
      <!-- ìƒë‹¨ ë¡œê·¸ì¸/í”„ë¡œí•„ ë°” -->
      <div class="bar">
        <div class="who" id="loginStatus" aria-live="polite">
          <span class="dot" aria-hidden="true"></span>
          <div>
            <div class="name">ë¡œê·¸ì¸ë¨</div>
            <div class="meta" id="userMeta">-í•™ë…„ -ë°˜ -ë²ˆ</div>
          </div>
        </div>
        <div class="thought-trigger">
          <button class="btn ghost" type="button" id="thoughtOpenBtn" aria-label="ìƒê° ì˜¬ë¦¬ê¸°">ğŸ’­</button>
          <button class="btn ghost" type="button" id="logoutBtn" aria-label="ë¡œê·¸ì•„ì›ƒ">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
      </div>

      <!-- í˜„ì¬ ìƒíƒœ í‘œì‹œ -->
      <div class="now" role="region" aria-labelledby="now-title">
        <h3 id="now-title">í˜„ì¬ ì„ íƒëœ ìƒíƒœ<span id="unsavedIndicator" style="font-size: 0.7em; color: #ff7a7a; margin-left: 8px; display: none;">(ì €ì¥ ì•ˆ ë¨)</span></h3>
        <div class="val" id="currentStatus">êµì‹¤</div>
      </div>

      <!-- ìƒíƒœ ì„ íƒ -->
      <div>
        <div class="section-head">ë‚´ ìœ„ì¹˜/ìƒíƒœ ì„ íƒ</div>
        <div class="grid" id="statusGrid">
          <div class="status-card" data-status="í™”ì¥ì‹¤(ë¬¼)" tabindex="0" role="button" aria-label="í™”ì¥ì‹¤(ë¬¼)">
            <div class="status-label">í™”ì¥ì‹¤(ë¬¼)</div>
            <div class="status-desc">ê¸‰íˆ ìë¦¬ ë¹„ì›€</div>
          </div>
          <div class="status-card" data-status="ë³µë„" tabindex="0" role="button" aria-label="ë³µë„">
            <div class="status-label">ë³µë„</div>
            <div class="status-desc">êµì‹¤ ì£¼ë³€ ì´ë™</div>
          </div>
          <div class="status-card" data-status="ë™ì•„ë¦¬" tabindex="0" role="button" aria-label="ë™ì•„ë¦¬">
            <div class="status-label">ë™ì•„ë¦¬</div>
            <div class="status-desc">ë™ì•„ë¦¬ì‹¤/í™œë™</div>
          </div>
          <div class="status-card" data-status="ë°©ê³¼í›„" tabindex="0" role="button" aria-label="ë°©ê³¼í›„">
            <div class="status-label">ë°©ê³¼í›„</div>
            <div class="status-desc">ë°©ê³¼í›„</div>
          </div>
          <div class="status-card" data-status="í”„ë¡œì íŠ¸" tabindex="0" role="button" aria-label="í”„ë¡œì íŠ¸">
            <div class="status-label">í”„ë¡œì íŠ¸</div>
            <div class="status-desc">í”„ë¡œì íŠ¸ì‹¤</div>
          </div>
          <div class="status-card" data-status="ì¡°ê¸°ì…ì‹¤" tabindex="0" role="button" aria-label="ì¡°ê¸°ì…ì‹¤">
            <div class="status-label">ì¡°ê¸°ì…ì‹¤</div>
            <div class="status-desc">ì•„íŒŒìš”ã… </div>
          </div>

          <!-- ê¸°íƒ€ -->
          <div class="status-card" data-status="ê¸°íƒ€" tabindex="0" role="button" aria-label="ê¸°íƒ€">
            <div class="status-label">ê¸°íƒ€</div>
            <div class="status-desc">ì‚¬ìœ  ì§ì ‘ ì…ë ¥</div>
            <div class="etc-box" id="etcBox" aria-hidden="true">
              <div class="etc-row">
                <input id="etcInput" class="input" type="text" placeholder="ì˜ˆ: ë³‘ì› ì˜ˆì•½, ìƒë‹´, ê¸‰í•œ ìš©ë¬´ ë“± ì…ë ¥" />
                <button id="etcAddBtn" class="btn ghost" type="button" style="min-width:72px">ì¶”ê°€</button>
              </div>
              <div id="etcChips" class="chip-list" aria-live="polite"></div>
            </div>
          </div>

          <div class="status-card" data-status="ê²°ì„(ì¡°í‡´)" tabindex="0" role="button" aria-label="ê²°ì„(ì¡°í‡´)">
            <div class="status-label">ê²°ì„(ì¡°í‡´)</div>
            <div class="status-desc">í•™êµì¥ ì¸ì •/ì‚¬ìœ  í™•ì¸</div>
          </div>
        </div>
      </div>

      <div class="status-card" data-status="êµì‹¤" tabindex="0" role="button" aria-label="êµì‹¤">
          <div class="status-label">êµì‹¤</div>
          <div class="status-desc">êµì‹¤ì— ìˆì–´ìš”</div>
      </div>

      <!-- ì™„ë£Œ -->
      <div class="submit-wrap">
        <button class="btn cta" id="submitBtn" type="button" aria-label="ìƒíƒœ ì €ì¥">ì™„ë£Œ</button>
      </div>
    </section>

    <!-- RIGHT: brand / highlights -->
    <section class="panel side" aria-label="ë¸Œëœë“œ & í•˜ì´ë¼ì´íŠ¸">
      <div class="time" id="timeDisplay" aria-live="polite"></div>

      <div class="brand fade-up">
        <img class="logo" aria-hidden="true" src="/src/dimicheck_templogo.png" alt="">
        <div>DimiCheck</div>
      </div>

      <div class="bigcopy fade-up">
        <h1 class="h1">í•œ ë²ˆì˜ íƒ­ìœ¼ë¡œ<br/>ë‚´ ìƒíƒœë¥¼ ì •í™•íˆ</h1>
        <p class="p">ë””ë¯¸ê³ ë¥¼ ìœ„í•œ ìƒˆë¡œìš´ ì¶œê²°Â·ìƒíƒœ í”Œë«í¼</p>
      </div>

      <div class="hero-cta fade-up" aria-label="í•˜ì´ë¼ì´íŠ¸">
        <div class="chipx">ê°„í¸í•œ ì¶œê²° ì¸ì¦</div>
        <div class="chipx">ì›ê²© ìƒíƒœ í™•ì¸</div>
        <div class="chipx">ì‹¤ì‹œê°„ ë™ê¸°í™”</div>
      </div>

      <svg class="illus" viewBox="0 0 600 380" fill="none" aria-hidden="true">
        <defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
          <stop offset="0%" stop-color="var(--primary)"/><stop offset="100%" stop-color="var(--primary-2)"/>
        </linearGradient></defs>
        <rect x="30" y="40" width="540" height="300" rx="26" fill="url(#g)" opacity=".18"/>
        <rect x="60" y="70" width="480" height="60" rx="14" fill="#fff" opacity=".14"/>
        <rect x="60" y="150" width="240" height="180" rx="18" fill="#fff" opacity=".12"/>
        <rect x="320" y="150" width="220" height="120" rx="18" fill="#fff" opacity=".1"/>
        <circle cx="520" cy="110" r="10" fill="#fff" opacity=".8"/>
        <circle cx="490" cy="110" r="10" fill="#fff" opacity=".6"/>
        <circle cx="460" cy="110" r="10" fill="#fff" opacity=".4"/>
      </svg>
    </section>
    <div class="spacer"></div>
  </main>

  <div id="thoughtOverlay" class="thought-overlay" hidden>
    <div class="thought-dialog" role="dialog" aria-modal="true" aria-labelledby="thoughtTitle">
      <button class="thought-close" type="button" id="thoughtCloseBtn" aria-label="ë‹«ê¸°">Ã—</button>
      <h2 id="thoughtTitle">ğŸ’­ ì–´ë–¤ ìƒê°ì„ í•˜ê³  ìˆë‚˜ìš”?</h2>
      <textarea id="thoughtInput" class="thought-input" maxlength="140" placeholder="ì–´ë–¤ ìƒê°ì„ í•˜ê³  ìˆë‚˜ìš”? 140ìê¹Œì§€ ì…ë ¥ ê°€ëŠ¥í•´ìš”." aria-label="ìƒê° ì…ë ¥"></textarea>
      <div class="thought-actions">
        <button class="btn cta" id="thoughtSendBtn" type="button">ì˜¬ë¦¬ê¸°</button>
        <button class="btn ghost" id="thoughtClearBtn" type="button">ì§€ìš°ê¸°</button>
      </div>
      <p class="thought-hint">ì˜¬ë¦¬ë©´ ìê¸° ë²ˆí˜¸ ìì„ì— ë§í’ì„ ìœ¼ë¡œ ì•½ 5ì´ˆê°„ í‘œì‹œë¼ìš”.</p>
      <p class="thought-feedback" id="thoughtStatus" aria-live="polite"></p>
    </div>
  </div>

  <script>
    // ===== ê¸€ë¡œë²Œ ìƒíƒœ =====
    let myGrade = null, mySection = null, myNumber = null;
    let selectedStatus = null;
    let lastSavedStatus = null;
    const currentStatusDisplay = document.getElementById('currentStatus');

    // Get the unsaved indicator element
    const unsavedIndicator = document.getElementById('unsavedIndicator');

    // ê¸°íƒ€ ì…ë ¥ ê´€ë¦¬
    const etcCard  = document.querySelector('.status-card[data-status="ê¸°íƒ€"]');
    const etcBox   = document.getElementById('etcBox');
    const etcInput = document.getElementById('etcInput');
    const etcAddBtn= document.getElementById('etcAddBtn');
    const etcChips = document.getElementById('etcChips');
    const etcItems = []; // For single value display
    const thoughtInput = document.getElementById('thoughtInput');
    const thoughtSendBtn = document.getElementById('thoughtSendBtn');
    const thoughtClearBtn = document.getElementById('thoughtClearBtn');
    const thoughtStatus = document.getElementById('thoughtStatus');
    const thoughtOverlay = document.getElementById('thoughtOverlay');
    const thoughtOpenBtn = document.getElementById('thoughtOpenBtn');
    const thoughtCloseBtn = document.getElementById('thoughtCloseBtn');
    let isPostingThought = false;

    // ë¼ë²¨ ë³€í™˜
    const categoryLabels = {
      toilet: "í™”ì¥ì‹¤(ë¬¼)",
      hallway: "ë³µë„",
      club: "ë™ì•„ë¦¬",
      afterschool: "ë°©ê³¼í›„",
      project: "í”„ë¡œì íŠ¸",
      early: "ì¡°ê¸°ì…ì‹¤",
      etc: "ê¸°íƒ€",
      absence: "ê²°ì„(ì¡°í‡´)",
      section: "êµì‹¤",
    };
    const reverseCategoryLabels = Object.fromEntries(
      Object.entries(categoryLabels).map(([k, v]) => [v, k])
    );

    // ===== ì‹œê°„ í‘œì‹œ =====
    function updateTime() {
      const now = new Date();
      const s = now.toLocaleString('ko-KR', {hour:'2-digit', minute:'2-digit', second:'2-digit'});
      document.getElementById('timeDisplay').textContent = s;
    }
    updateTime(); setInterval(updateTime, 1000);

    function setThoughtFeedback(message, tone = 'info') {
      if (!thoughtStatus) return;
      thoughtStatus.textContent = message;
      thoughtStatus.classList.remove('success', 'error');
      if (tone !== 'info') {
        thoughtStatus.classList.add(tone);
      }
    }

    function setThoughtControlsDisabled(disabled) {
      if (thoughtSendBtn) thoughtSendBtn.disabled = disabled;
      if (thoughtClearBtn) thoughtClearBtn.disabled = disabled;
    }

    function updateThoughtStatusFromState(data) {
      if (!thoughtStatus) return;
      if (data && data.thought && data.thoughtExpiresAt) {
        const expiresAtTime = Date.parse(data.thoughtExpiresAt);
        if (!Number.isNaN(expiresAtTime) && expiresAtTime > Date.now()) {
          setThoughtFeedback('ë§í’ì„ ì´ ì ì‹œ í‘œì‹œ ì¤‘ì´ì—ìš”.', 'info');
          return;
        }
      }
      setThoughtFeedback('í˜„ì¬ ë§í’ì„ ì´ ì—†ìŠµë‹ˆë‹¤.', 'info');
    }

    function openThoughtDialog() {
      if (!thoughtOverlay) return;
      thoughtOverlay.hidden = false;
      setThoughtControlsDisabled(isPostingThought);
      requestAnimationFrame(() => {
        setTimeout(() => thoughtInput?.focus(), 0);
      });
    }

    function closeThoughtDialog() {
      if (!thoughtOverlay) return;
      thoughtOverlay.hidden = true;
    }

    async function submitThoughtBubble() {
      if (!thoughtInput || !thoughtSendBtn) return;
      if (!myGrade || !mySection || !myNumber) {
        alert('ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
        return;
      }
      if (isPostingThought) return;

      const text = thoughtInput.value.trim();
      if (!text) {
        setThoughtFeedback('ìƒê°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
        thoughtInput.focus();
        return;
      }

      isPostingThought = true;
      setThoughtControlsDisabled(true);
      setThoughtFeedback('ë§í’ì„ ì„ ë³´ë‚´ëŠ” ì¤‘...', 'info');

      try {
        const res = await fetch(`/api/classes/thought?grade=${myGrade}&section=${mySection}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ thought: text, duration: 5 })
        });
        if (!res.ok) {
          const errText = await res.text();
          throw new Error(errText || 'thought request failed');
        }
        const data = await res.json();
        thoughtInput.value = '';
        setThoughtFeedback('ë§í’ì„ ì´ ìì„ì— í‘œì‹œëì–´ìš”!', 'success');
        updateThoughtStatusFromState(data);
      } catch (err) {
        console.error('submitThoughtBubble error:', err);
        setThoughtFeedback('ë§í’ì„ ì„ ë³´ë‚´ì§€ ëª»í–ˆì–´ìš”. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
      } finally {
        isPostingThought = false;
        setThoughtControlsDisabled(false);
      }
    }

    async function clearThoughtBubble() {
      if (!myGrade || !mySection || !myNumber) {
        alert('ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
        return;
      }
      if (isPostingThought) return;

      isPostingThought = true;
      setThoughtControlsDisabled(true);
      setThoughtFeedback('ë§í’ì„ ì„ ì§€ìš°ëŠ” ì¤‘...', 'info');

      try {
        const res = await fetch(`/api/classes/thought?grade=${myGrade}&section=${mySection}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ thought: '' })
        });
        if (!res.ok) {
          const errText = await res.text();
          throw new Error(errText || 'thought clear failed');
        }
        await res.json();
        setThoughtFeedback('ë§í’ì„ ì„ ì§€ì› ì–´ìš”.', 'success');
        updateThoughtStatusFromState(null);
      } catch (err) {
        console.error('clearThoughtBubble error:', err);
        setThoughtFeedback('ë§í’ì„ ì„ ì§€ìš°ì§€ ëª»í–ˆì–´ìš”. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
      } finally {
        isPostingThought = false;
        setThoughtControlsDisabled(false);
      }
    }

    updateThoughtStatusFromState(null);

    // ===== ë¡œê·¸ì¸ ì²´í¬ & í˜„ì¬ ìƒíƒœ ë¶ˆëŸ¬ì˜¤ê¸° =====
    async function checkLogin() {
      try {
        const res = await fetch("/auth/status", { credentials: "include" });
        if (!res) { location.href = "/auth/login"; return; }
        const data = await res.json();

        if (!data.logged_in) { location.href = "/auth/login"; return; }

        myGrade   = Math.floor(data.number/1000);
        mySection = Math.floor((data.number%1000)/100);
        myNumber  = Math.floor(data.number%100);

        document.getElementById("userMeta").textContent =
          `${myGrade}í•™ë…„ ${mySection}ë°˜ ${myNumber}ë²ˆ`;

        await loadMyState();
      } catch (e) {
        console.warn("checkLogin failed:", e);
        location.href = "/auth/login";
      }
    }

    async function loadMyState() {
      try {
        const res = await fetch(`/api/classes/state/load?grade=${myGrade}&section=${mySection}`);
        if (!res.ok) throw new Error("ìƒíƒœ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
        const parsed = await res.json();
        const magnets = parsed.magnets || {};
        const me = magnets[myNumber];

        if (!me) {
          currentStatusDisplay.textContent = "êµì‹¤";
          lastSavedStatus = "êµì‹¤";
          updateThoughtStatusFromState(null);
          return;
        }

        if (me.attachedTo === "etc" && me.reason) {
          currentStatusDisplay.textContent = `ê¸°íƒ€ - ${me.reason}`;
          lastSavedStatus = `ê¸°íƒ€ - ${me.reason}`;
        } else {
          const label = categoryLabels[me.attachedTo] || me.attachedTo;
          currentStatusDisplay.textContent = label || "êµì‹¤";
          lastSavedStatus = label || "êµì‹¤";
        }
        updateThoughtStatusFromState(me);
      } catch (e) {
        console.error("loadMyState error:", e);
        currentStatusDisplay.textContent = "êµì‹¤";
        updateThoughtStatusFromState(null);
      }
    }

    // ===== ìƒíƒœ ì¹´ë“œ ì„ íƒ ì²˜ë¦¬ =====
    function refreshCurrentStatus() {
      let displayStatus = selectedStatus ?? 'â€”';
      let isUnsaved = false;

      if (selectedStatus === 'ê¸°íƒ€' && etcItems.length > 0) {
        displayStatus = `ê¸°íƒ€ - ${etcItems[0]}`;
      }

      currentStatusDisplay.textContent = displayStatus;

      // Determine if it's unsaved
      if (selectedStatus && displayStatus !== lastSavedStatus) {
        isUnsaved = true;
      }
      if (unsavedIndicator) {
        unsavedIndicator.style.display = isUnsaved ? 'inline' : 'none';
      }
      currentStatusDisplay.style.animation = 'none';
      requestAnimationFrame(() => {
        currentStatusDisplay.style.animation = 'rise .3s ease-out';
      });
    }

    function setSelected(card) {
      const wasSelected = selectedStatus === card.dataset.status;

      // í•´ì œ
      if (wasSelected) {
        card.classList.remove('selected','completed');
        selectedStatus = null;
        etcBox.style.display = 'none';
        etcBox.setAttribute('aria-hidden','true');
        refreshCurrentStatus();
        return;
      }

      // ìƒˆ ì„ íƒ
      document.querySelectorAll('.status-card').forEach(c => c.classList.remove('selected','completed'));
      card.classList.add('selected');
      selectedStatus = card.dataset.status;

      const isEtc = selectedStatus === 'ê¸°íƒ€';
      etcBox.style.display = isEtc ? 'flex' : 'none';
      etcBox.setAttribute('aria-hidden', String(!isEtc));
      if (isEtc) etcInput?.focus();

      refreshCurrentStatus();
    }

    // í‚¤ë³´ë“œ ì ‘ê·¼ì„±(Enter/Space)
    document.querySelectorAll('.status-card').forEach(card => {
      card.addEventListener('click', () => setSelected(card));
      card.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          setSelected(card);
        }
      });
    });

    // ê¸°íƒ€ ì…ë ¥
    function renderChips() {
      etcChips.innerHTML = '';
      etcItems.forEach((txt, idx) => {
        const chip = document.createElement('span');
        chip.className = 'chip';
        chip.innerHTML = `<span>${txt}</span><button class="del" aria-label="ì‚­ì œ" data-idx="${idx}">Ã—</button>`;
        etcChips.appendChild(chip);
      });
    }
    function addEtcItem(text) {
      if (!text) return;
      etcItems.length = 0; // ë‹¨ì¼ ìœ ì§€
      etcItems.push(text.trim());
      renderChips();
      etcInput.value = '';
      refreshCurrentStatus();
    }

    [etcInput, etcAddBtn, etcChips].forEach(el => {
      el.addEventListener('click', (e) => e.stopPropagation());
    });
    etcAddBtn.addEventListener('click', () => addEtcItem(etcInput.value));
    etcInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') { e.preventDefault(); addEtcItem(etcInput.value); }
    });
    etcChips.addEventListener('click', (e) => {
      const btn = e.target.closest('.del');
      if (!btn) return;
      const idx = Number(btn.dataset.idx);
      etcItems.splice(idx,1);
      renderChips();
      refreshCurrentStatus();
    });

    if (thoughtOpenBtn) {
      thoughtOpenBtn.addEventListener('click', openThoughtDialog);
    }
    if (thoughtCloseBtn) {
      thoughtCloseBtn.addEventListener('click', closeThoughtDialog);
    }
    if (thoughtOverlay) {
      thoughtOverlay.addEventListener('mousedown', (e) => {
        if (e.target === thoughtOverlay) {
          closeThoughtDialog();
        }
      });
    }
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && thoughtOverlay && !thoughtOverlay.hidden) {
        closeThoughtDialog();
      }
    });

    if (thoughtSendBtn) {
      thoughtSendBtn.addEventListener('click', submitThoughtBubble);
    }
    if (thoughtClearBtn) {
      thoughtClearBtn.addEventListener('click', clearThoughtBubble);
    }
    if (thoughtInput) {
      thoughtInput.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
          e.preventDefault();
          submitThoughtBubble();
        }
      });
    }

    // ===== ì €ì¥ =====
    async function saveMyState(statusLabel, reason = null) {
      if (!myGrade || !mySection || !myNumber) { alert("ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }
      const key = reverseCategoryLabels[statusLabel] || statusLabel;

      const magnets = {};
      magnets[myNumber] = { attachedTo: key, reason: reason };

      try {
        const res = await fetch(`/api/classes/state/save?grade=${myGrade}&section=${mySection}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ magnets })
        });
        if (!res.ok) throw new Error(await res.text());
        // ì™„ë£Œ ë¹„ì£¼ì–¼
        const selected = document.querySelector('.status-card.selected');
        selected?.classList.add('completed');
        lastSavedStatus = selectedStatus;
      } catch (e) {
        console.error("saveMyState failed:", e);
        alert("ì €ì¥ ì‹¤íŒ¨: " + e.message);
      }
    }

    document.getElementById('submitBtn').addEventListener('click', async () => {
      if (!selectedStatus) { alert("ìƒíƒœë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”."); return; }
      const reason = (selectedStatus === "ê¸°íƒ€" && etcItems.length > 0) ? etcItems[0] : null;
      await saveMyState(selectedStatus, reason);
      refreshCurrentStatus();
    });

    // ===== ë¡œê·¸ì•„ì›ƒ (ì„ íƒ) =====
    document.getElementById('logoutBtn').addEventListener('click', () => {
      location.href = '/auth/logout';
    });

    // ì§„ì… ì‹œ ë¡œê·¸ì¸ í™•ì¸
    checkLogin();
  </script>
  <nav class="bottom-nav">
    <a href="/routine.html" class="nav-item" aria-current="page">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M7 2a1 1 0 0 1 1 1v1h8V3a1 1 0 1 1 2 0v1h1a3 3 0 0 1 3 3v11a3 3 0 0 1-3 3H4a3 3 0 0 1-3-3V7a3 3 0 0 1 3-3h1V3a1 1 0 0 1 1-1Zm13 8H4v9a1 1 0 0 0 1 1h14a1 1 0 0 0 1-1v-9ZM6 7h12V6H6v1Z"/></svg>
      <span>ë£¨í‹´</span>
    </a>
    <a href="/user.html" class="nav-item active" aria-current="page">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8h5z"></path></svg>
      <span>í™ˆ</span>
    </a>
    <a href="/schoollife.html" class="nav-item">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24"><path d="M12 3L1 9l4 2.18v6.32L12 21l7-3.5V11.18L23 9 12 3zm0 2.69L17.53 9 12 11.31 6.47 9 12 5.69zM18 17.18l-5 2.5v-5.81l5-2.5v5.81z"></path></svg>
      <span>í•™êµ ìƒí™œ</span>
    </a>
  </nav>
</body>
</html>
