<!DOCTYPE html>
<html lang="ko">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-NX4P51JHZD"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-NX4P51JHZD');
  </script>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <meta name="theme-color" content="#0b0f14"/>
  <meta name="application-name" content="DIMI Check"/>
  <meta name="mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <link rel="manifest" href="/manifest.webmanifest">
  <script>
    (function(){
      try{
        const raw = localStorage.getItem('dimicheck:settings');
        if(!raw) return;
        const parsed = JSON.parse(raw);
        if(parsed.theme === 'light' || parsed.theme === 'dark'){
          document.documentElement.dataset.theme = parsed.theme;
        }else{
          delete document.documentElement.dataset.theme;
        }
      }catch(err){
        console.warn('[Theme] preload failed', err);
      }
    })();
  </script>
  <script defer src="/js/pwa.js"></script>
  <script defer src="/js/preferences.js"></script>
  <script defer src="/js/notifications.js"></script>
  <title>DIMI Check</title>
  <meta name="color-scheme" content="light dark" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="apple-touch-icon" sizes="180x180" href="src/favicon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="src/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="src/favicon/favicon-16x16.png">
  <script defer src="/js/chat.js"></script>
  <script defer src="/js/voting.js"></script>
  <script defer src="/js/reactions.js"></script>
<style>
    :root{
      --bg: #0b0f14;
      --bg-2: #0e1218;
      --card: rgba(255,255,255,.08);
      --card-2: rgba(255,255,255,.06);
      --text: #e9eef6;
      --muted: #a7b0c0;
      --primary: #d04fff;
      --primary-2: #ff6ad0;
      --ring: 0 0 0 8px color-mix(in oklab, var(--primary) 30%, transparent);
      --shadow: 0 10px 30px rgba(0, 0, 0, .45);
      --radius: 20px;
    }
    :root[data-theme="light"]{
      --bg: #f6f8fb;
      --bg-2: #eef2f8;
      --card: rgba(255,255,255,.75);
      --card-2: rgba(255,255,255,.6);
      --text: #0f172a;
      --muted: #5b6475;
      --primary: #d04fff;
      --primary-2: #ff6ad0;
      --shadow: 0 10px 30px rgba(57,72,103,.15);
    }
    :root[data-theme="dark"]{
      --bg: #0b0f14;
      --bg-2: #0e1218;
      --card: rgba(255,255,255,.08);
      --card-2: rgba(255,255,255,.06);
      --text: #e9eef6;
      --muted: #a7b0c0;
      --primary: #d04fff;
      --primary-2: #ff6ad0;
      --shadow: 0 10px 30px rgba(0, 0, 0, .45);
    }
    @media (prefers-color-scheme: light) {
      :root:not([data-theme="dark"]) {
        --bg: #f6f8fb;
        --bg-2: #eef2f8;
        --card: rgba(255,255,255,.75);
        --card-2: rgba(255,255,255,.6);
        --text: #0f172a;
        --muted: #5b6475;
        --primary: #d04fff;
        --primary-2: #ff6ad0;
        --shadow: 0 10px 30px rgba(57,72,103,.15);
      }
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:"Pretendard",system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,sans-serif;
      color:var(--text);
      background:var(--bg);
      display:grid;
      place-items:center;
      overflow:auto;
    }

    /* background blobs */
    .blob-container{
      position:fixed; inset:0; overflow:hidden; z-index:-1;
      background: radial-gradient(1200px 800px at 10% -10%, #5a6cff20, transparent 60%),
                  radial-gradient(1200px 800px at 110% 10%, #ff009025, transparent 60%),
                  radial-gradient(1000px 700px at 50% 120%, #ff00b325, transparent 60%);
    }
    .blob{position:absolute; filter:blur(40px); opacity:.6; pointer-events:none}
    .b1{width:48vw;height:48vw;background:radial-gradient(circle,#ff6a6a60,transparent 70%); top:-10vh; left:-10vw; animation:float 18s ease-in-out infinite}
    /* .b2{width:42vw;height:42vw;background:radial-gradient(circle,#e100ff50,transparent 70%); bottom:-15vh; right:-10vw; animation:float 22s ease-in-out infinite reverse} */
    .b2{width:42vw;height:42vw;background:radial-gradient(circle,#038b2550,transparent 70%); bottom:-15vh; right:-10vw; animation:float 22s ease-in-out infinite reverse}
    .b3{width:36vw;height:36vw;background:radial-gradient(circle,#ff6ae950,transparent 70%); top:40vh; left:10vw; animation:float 26s ease-in-out infinite}
    @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-20px)}}

    /* shell layout */
    .shell{
      position:relative;
      width:min(1100px,92vw);
      min-height:min(720px,92vh);
      height:auto;
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      grid-template-areas:'main side';
      gap:18px; padding:18px; z-index:1;
    }
    @media (max-width: 1024px){
      .shell{
        grid-template-columns:1fr;
        grid-template-areas:'main' 'side';
        min-height:auto;
        height:auto;
      }
    }

    .panel{
      position:relative; overflow:clip; border-radius:var(--radius);
      background:linear-gradient(180deg,var(--card),var(--card-2));
      backdrop-filter:saturate(140%) blur(14px);
      box-shadow:var(--shadow);
    }

    /* left: main interactions */
    .main{
      grid-area:main;
      display:grid;
      grid-template-rows:auto auto 1fr auto;
      gap:14px;
      padding:24px;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      padding-bottom:calc(24px + env(safe-area-inset-bottom, 0px));
    }
    .bar{
      display:flex; justify-content:space-between; align-items:center; gap:12px;
    }
    .who{
      display:flex; align-items:center; gap:12px;
    }
    .dot{width:10px;height:10px;border-radius:50%; background: #3ae374; box-shadow:0 0 10px #3ae37480}
    .who .name{font-weight:700}
    .who .meta{color:var(--muted); font-size:13px}

    .now{
      padding:16px;
      border:1px solid color-mix(in oklab, var(--text) 12%, transparent);
      border-radius:calc(var(--radius) + 4px);
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
    }
    .now h3{margin:0 0 6px; font-size:16px; letter-spacing:.2px}
    .now .val{font-size:28px; font-weight:700; line-height:1.2}

    .section-head{
      margin-top:6px; font-size:15px; color:var(--muted); letter-spacing:.5px
    }

    .grid{
      display:grid; grid-template-columns:repeat(2, 1fr); gap:14px; margin-top:8px;
    }
    @media (max-width:700px){ .grid{grid-template-columns:1fr} }

    .status-card{
      cursor:pointer; position:relative; padding:16px 16px 18px;
      border-radius:16px; border:1px solid color-mix(in oklab, var(--text) 12%, transparent);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      transition:all .3s cubic-bezier(0.34, 1.56, 0.64, 1);
      overflow:hidden;
    }
    .status-card::before{
      content:'';
      position:absolute;
      top:50%;
      left:50%;
      width:0;
      height:0;
      border-radius:50%;
      background:rgba(255,255,255,.15);
      transform:translate(-50%,-50%);
      transition:width .6s ease, height .6s ease;
    }
    .status-card:active::before{
      width:400px;
      height:400px;
    }
    .status-card:hover{
      transform:translateY(-4px) scale(1.02);
      box-shadow:0 8px 24px rgba(0,0,0,.2);
    }
    .status-card:active{
      transform:scale(0.97);
      box-shadow:0 0 0 4px color-mix(in oklab, var(--primary) 15%, transparent);
    }
    .status-card.selected{
      transform:translateY(-2px) scale(1.02);
      box-shadow:var(--ring);
      border-color: color-mix(in oklab, var(--primary) 50%, transparent);
      background:linear-gradient(180deg, color-mix(in oklab, var(--primary) 10%, rgba(255,255,255,.1)), rgba(255,255,255,.05));
      animation:bounce-in .4s cubic-bezier(0.34, 1.2, 0.64, 1);
    }
    @keyframes bounce-in{
      0%{transform:translateY(-2px) scale(0.95)}
      50%{transform:translateY(-2px) scale(1.04)}
      100%{transform:translateY(-2px) scale(1.02)}
    }
    .status-card.selected:active{
      box-shadow:0 0 0 10px color-mix(in oklab, var(--primary) 35%, transparent);
    }
    .status-card.selected.completed{
      box-shadow:0 0 0 8px color-mix(in oklab, #38d67a 28%, transparent);
      border-color: color-mix(in oklab, #38d67a 45%, transparent);
      animation:success-pulse .5s ease;
    }
    @keyframes success-pulse{
      0%, 100%{transform:translateY(-2px) scale(1.02)}
      50%{transform:translateY(-2px) scale(1.05); box-shadow:0 0 0 10px color-mix(in oklab, #38d67a 32%, transparent)}
    }
    .status-label{font-weight:800; letter-spacing:.2px; margin-bottom:6px}
    .status-desc{color:var(--muted); font-size:13px}

    .etc-box{ display:none; gap:10px; margin-top:12px; flex-wrap:wrap }
    .etc-row{ display:flex; gap:10px; width:100% }
    .input{
      width:100%; height:44px; padding:0 14px; border-radius:12px; outline:none; font-size:14px; color:var(--text);
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      border:1px solid color-mix(in oklab, var(--text) 18%, transparent);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.08);
    }
    .chip-list{display:flex; flex-wrap:wrap; gap:8px}
    .chip{
      display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px;
      border:1px solid color-mix(in oklab, var(--text) 18%, transparent);
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      font-size:13px;
    }
    .chip .del{
      background:transparent; border:0; color:var(--text); opacity:.7; cursor:pointer; font-size:18px; line-height:1; padding:0 4px;
    }
    .chip .del:hover{opacity:1}

    .btn{
      appearance:none; border:0; cursor:pointer; width:100%;
      display:flex; align-items:center; justify-content:center; gap:10px;
      padding:12px 14px; border-radius:12px; font-weight:700;
      color:#0b0f14; background:#fff; box-shadow:0 2px 0 rgba(0,0,0,.05);
      transition:all .2s cubic-bezier(0.4, 0, 0.2, 1);
      position:relative;
      overflow:hidden;
    }
    .btn::before{
      content:'';
      position:absolute;
      top:50%;
      left:50%;
      width:0;
      height:0;
      border-radius:50%;
      background:rgba(208,79,255,.2);
      transform:translate(-50%,-50%);
      transition:width .6s ease, height .6s ease;
    }
    .btn:active::before{
      width:300px;
      height:300px;
    }
    .btn:active{
      transform:scale(0.96);
      box-shadow:0 0 0 4px color-mix(in oklab, var(--primary) 20%, transparent), 0 4px 12px rgba(0,0,0,.15);
    }
    .btn.ghost{
      background:transparent; color:var(--text);
      border:1px solid color-mix(in oklab, var(--text) 12%, transparent); width:auto; padding:10px 12px;
    }
    .btn.ghost:active{
      box-shadow:0 0 0 4px color-mix(in oklab, var(--text) 15%, transparent);
    }
    .btn.cta{
      background:linear-gradient(135deg, var(--primary), var(--primary-2));
      color:#fff;
    }
    @keyframes btnGlow{
      0%, 100%{box-shadow:0 0 0 4px color-mix(in oklab, var(--primary) 20%, transparent), 0 4px 12px rgba(208, 79, 255, .3);}
      50%{box-shadow:0 0 0 6px color-mix(in oklab, var(--primary) 25%, transparent), 0 6px 16px rgba(208, 79, 255, .4);}
    }

    /* ì™„ë£Œ ë²„íŠ¼ ì„±ê³µ ì• ë‹ˆë©”ì´ì…˜ */
    .btn.cta.success-animation{
      background:linear-gradient(135deg, #38d67a, #2eb869) !important;
      animation:successGlow 0.6s ease-out;
    }
    @keyframes successGlow{
      0%, 100%{box-shadow:0 0 0 4px color-mix(in oklab, #38d67a 25%, transparent), 0 4px 12px rgba(56, 214, 122, .3);}
      50%{box-shadow:0 0 0 8px color-mix(in oklab, #38d67a 30%, transparent), 0 6px 16px rgba(56, 214, 122, .5);}
    }

    /* currentStatus ìŠ¤í¬ë¡¤ ì• ë‹ˆë©”ì´ì…˜ */
    @keyframes statusScrollOut{
      0%{transform:translateY(0); filter:blur(0px); opacity:1;}
      100%{transform:translateY(-20px); filter:blur(8px); opacity:0;}
    }
    @keyframes statusScrollIn{
      0%{transform:translateY(20px); filter:blur(8px); opacity:0;}
      100%{transform:translateY(0); filter:blur(0px); opacity:1;}
    }
    .status-scroll-out{animation:statusScrollOut 0.35s cubic-bezier(0.4, 0, 0.6, 1) forwards;}
    .status-scroll-in{animation:statusScrollIn 0.35s cubic-bezier(0.4, 0, 0.6, 1) forwards;}

    /* ì €ì¥ ì•ˆë¨ ìŠ¬ë¼ì´ë“œ ì• ë‹ˆë©”ì´ì…˜ */
    @keyframes slideInFromLeft{
      0%{transform:translateX(-20px); opacity:0;}
      100%{transform:translateX(0); opacity:1;}
    }
    @keyframes slideOutToLeft{
      0%{transform:translateX(0); opacity:1;}
      100%{transform:translateX(-20px); opacity:0;}
    }
    .unsaved-slide-in{animation:slideInFromLeft 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;}
    .unsaved-slide-out{animation:slideOutToLeft 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;}

    .submit-wrap{ margin-top:4px }
    .thought-trigger{
      display:flex;
      align-items:center;
      gap:6px;
    }
    .thought-trigger .btn{
      min-width:auto;
      padding:10px 12px;
    }
    .thought-overlay{
      position:fixed;
      inset:0;
      background:rgba(5,8,12,0.65);
      backdrop-filter:blur(12px);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
      z-index:2000;
    }
    .thought-overlay[hidden]{
      display:none !important;
    }
    .thought-dialog{
      width:min(420px, 100%);
      background:linear-gradient(180deg, rgba(20,24,32,0.92), rgba(14,18,26,0.96));
      border-radius:20px;
      border:1px solid rgba(255,255,255,0.08);
      box-shadow:0 20px 60px rgba(0,0,0,0.45);
      color:#f4f7ff;
      padding:24px;
      display:flex;
      flex-direction:column;
      gap:16px;
    }
    .thought-dialog h2{
      margin:0;
      font-size:20px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .thought-close{
      position:absolute;
      top:16px;
      right:16px;
      background:transparent;
      border:0;
      color:inherit;
      font-size:20px;
      cursor:pointer;
    }
    .thought-input{
      width:100%;
      min-height:100px;
      padding:12px 14px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.18);
      background:rgba(12,16,24,0.65);
      color:inherit;
      font-size:14px;
      resize:vertical;
      font-family:inherit;
      box-shadow:inset 0 2px 6px rgba(0,0,0,0.35);
    }
    .thought-input::placeholder{color:rgba(235,240,255,0.45)}
    .thought-actions{display:flex; gap:10px; flex-wrap:wrap}
    .thought-actions .btn{flex:1 1 auto}
    .thought-hint{font-size:12px; color:rgba(235,240,255,0.55)}
    .thought-feedback{min-height:1.2em; font-size:13px; color:rgba(235,240,255,0.55)}
    .thought-feedback.success{color:#58e08a}
    .thought-feedback.error{color:#ff8484}
    .footer{ text-align:center; color:var(--muted); font-size:12px; margin-top:10px }

    /* ===== ì±„íŒ… UI ===== */
    .chat-container{
      display:flex;
      flex-direction:column;
      gap:12px;
      height:400px;
      max-height:60vh;
    }
    .chat-messages{
      flex:1;
      overflow-y:auto;
      display:flex;
      flex-direction:column;
      gap:12px;
      padding:4px;
    }
    .chat-message{
      display:flex;
      gap:10px;
      align-items:flex-start;
    }
    .chat-message.mine{
      flex-direction:row-reverse;
    }
    .chat-avatar{
      width:36px;
      height:36px;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:13px;
      font-weight:700;
      color:#fff;
      flex-shrink:0;
    }
    .chat-avatar.color-red{background:linear-gradient(135deg,#ff6b6b,#ff5252)}
    .chat-avatar.color-orange{background:linear-gradient(135deg,#ffa559,#ff8333)}
    .chat-avatar.color-yellow{background:linear-gradient(135deg,#ffd93d,#ffbb00)}
    .chat-avatar.color-green{background:linear-gradient(135deg,#6bcf7f,#4caf50)}
    .chat-avatar.color-teal{background:linear-gradient(135deg,#4dd4ac,#00bfa5)}
    .chat-avatar.color-blue{background:linear-gradient(135deg,#4d9de0,#2979ff)}
    .chat-avatar.color-purple{background:linear-gradient(135deg,#a78bfa,#8b5cf6)}
    .chat-avatar.color-pink{background:linear-gradient(135deg,#f472b6,#ec4899)}
    .chat-bubble{
      background:rgba(255,255,255,0.08);
      border-radius:12px;
      padding:8px 12px;
      max-width:70%;
      word-wrap:break-word;
    }
    .chat-message.mine .chat-bubble{
      background:linear-gradient(135deg,var(--primary),var(--primary-2));
    }
    .chat-number{
      font-size:11px;
      opacity:0.7;
      margin-bottom:4px;
    }
    .chat-text{
      font-size:14px;
      line-height:1.4;
    }
    .chat-time{
      font-size:10px;
      opacity:0.5;
      margin-top:4px;
      text-align:right;
    }
    .chat-empty{
      text-align:center;
      color:var(--muted);
      padding:40px 20px;
      font-size:14px;
    }
    .chat-input-container{
      display:flex;
      gap:8px;
      padding-top:8px;
      border-top:1px solid rgba(255,255,255,0.1);
    }
    .chat-input{
      flex:1;
      height:44px;
      padding:0 14px;
      border-radius:12px;
      outline:none;
      font-size:14px;
      color:var(--text);
      background:rgba(12,16,24,0.65);
      border:1px solid rgba(255,255,255,0.18);
    }
    .chat-input::placeholder{color:rgba(235,240,255,0.45)}
    .chat-toolbar{
      display:flex;
      gap:8px;
      padding-top:8px;
    }
    .chat-toolbar .btn{
      flex:1;
      padding:10px 14px;
    }

    /* ===== ì±„íŒ… í† ìŠ¤íŠ¸ & ë°°ì§€ ===== */
    .chat-toast{
      position:fixed;
      bottom:24px;
      right:24px;
      background:rgba(20,20,30,0.95);
      color:#fff;
      padding:14px 20px;
      border-radius:12px;
      box-shadow:0 4px 20px rgba(0,0,0,0.4);
      border:1px solid rgba(255,255,255,0.1);
      font-size:14px;
      z-index:9998;
      animation:slideInUp 0.3s ease;
      max-width:300px;
    }
    @keyframes slideInUp{
      from{transform:translateY(20px);opacity:0}
      to{transform:translateY(0);opacity:1}
    }
    .chat-badge{
      position:absolute;
      top:0;
      right:0;
      width:10px;
      height:10px;
      background:#ff3b57;
      border-radius:50%;
      border:2px solid var(--card-bg);
      box-shadow:0 0 8px rgba(255,59,87,0.6);
    }

    /* ===== íˆ¬í‘œ UI ===== */
    .vote-container{
      margin-top:16px;
      padding:16px;
      border:1px solid rgba(255,255,255,0.15);
      border-radius:14px;
      background:linear-gradient(180deg,rgba(138,75,246,0.1),rgba(208,79,255,0.05));
      display:none;
    }
    .vote-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:12px;
    }
    .vote-question{
      font-size:16px;
      font-weight:700;
      margin:0 0 8px;
    }
    .vote-countdown{
      font-size:14px;
      color:var(--primary);
      font-weight:600;
    }
    .vote-options{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin:12px 0;
    }
    .vote-option{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:10px;
      background:rgba(255,255,255,0.05);
      border:1px solid rgba(255,255,255,0.1);
      transition:background .2s ease;
    }
    .vote-option:hover{
      background:rgba(255,255,255,0.08);
    }
    .vote-option input{
      margin:0;
    }
    .vote-option label{
      flex:1;
      cursor:pointer;
    }
    .vote-count{
      font-size:13px;
      color:var(--muted);
    }
    .vote-create-btn{
      margin-top:8px;
    }

    /* ===== ë°˜ì‘ UI ===== */
    .reaction-picker{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      justify-content:center;
      padding:16px 0;
    }
    .reaction-emoji-btn{
      width:54px;
      height:54px;
      font-size:28px;
      border:2px solid rgba(255,255,255,0.15);
      border-radius:14px;
      background:rgba(255,255,255,0.05);
      cursor:pointer;
      transition:all .2s ease;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .reaction-emoji-btn:hover{
      transform:scale(1.1);
      background:rgba(255,255,255,0.1);
      border-color:var(--primary);
    }
    .reaction-emoji-btn:active{
      transform:scale(0.95);
    }
    .reaction-cooldown{
      text-align:center;
      font-size:13px;
      color:var(--muted);
      margin-top:8px;
      display:none;
    }
    .reaction-feedback{
      text-align:center;
      font-size:13px;
      color:rgba(235,240,255,0.55);
      min-height:1.2em;
    }
    .reaction-feedback.success{color:#58e08a}
    .reaction-feedback.error{color:#ff8484}

    /* right: brand / time / illustration */
    .side{grid-area:side; display:grid; grid-template-rows:auto 1fr auto; padding:24px}
    .brand{display:flex; align-items:center; gap:12px; font-weight:800; letter-spacing:.2px}
    .logo{width:36px;height:36px;border-radius:12px;display:grid;place-items:center;color:#fff;box-shadow:inset 0 0 18px #ffffff40}
    .bigcopy{align-self:center; padding:12px 6px}
    .h1{font-size:clamp(24px,3.2vw,40px); font-weight:800; line-height:1.1; letter-spacing:-.02em; margin:0 0 10px}
    .p{margin:0; color:var(--muted); font-size:clamp(14px,1.7vw,16px)}
    .hero-cta{align-self:end; display:flex; gap:10px; flex-wrap:wrap}
    .chipx{
      border-radius:999px; padding:8px 12px;
      background:color-mix(in oklab, var(--card) 70%, rgba(255,255,255,.12));
      border:1px solid color-mix(in oklab, var(--text) 12%, transparent);
      font-size:.88rem; color:var(--muted)
    }
    .time{
      position:absolute; top:24px; right:24px; font-size:13px; color:var(--muted); letter-spacing:.5px
    }
    .illus{
      position:absolute; right:-6%; bottom:-6%; width:min(520px,60%); opacity:.9;
      filter:drop-shadow(0 14px 30px rgba(0,0,0,.25)); pointer-events:none;
    }

    /* Bottom Navigation - Floating Rounded Style */
    .bottom-nav {
      position: fixed;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      width: min(480px, calc(100% - 32px));
      height: 68px;
      padding: 8px 12px calc(8px + env(safe-area-inset-bottom));
      display: flex;
      background: linear-gradient(180deg, var(--card), var(--card-2));
      backdrop-filter: saturate(180%) blur(20px);
      border-radius: 24px;
      border: 1px solid color-mix(in oklab, var(--text) 12%, transparent);
      box-shadow: 0 8px 32px rgba(0, 0, 0, .3), 0 0 0 1px rgba(255, 255, 255, .08) inset;
      z-index: 1000;
    }
    .nav-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      color: var(--muted);
      text-decoration: none;
      font-size: 11px;
      font-weight: 600;
      padding: 8px 4px;
      border-radius: 16px;
      transition: all .25s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }
    .nav-item:hover {
      color: var(--text);
      background: rgba(255, 255, 255, .06);
    }
    .nav-item.active {
      color: var(--primary);
      background: color-mix(in oklab, var(--primary) 12%, transparent);
    }
    .nav-item svg {
      width: 24px;
      height: 24px;
      transition: transform .25s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .nav-item:active svg {
      transform: scale(0.85);
    }

    .spacer {
      height: calc(68px + 32px + env(safe-area-inset-bottom));
    }

    @media (max-width:1024px){
      .illus{position:static; width:100%; margin-top:14px}
      .side{padding:20px}
    }

    /* motion */
    .fade-up{
      opacity:0;
      transform:translateY(20px) scale(0.95);
      filter:blur(8px);
      animation:rise .7s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    }
    .fade-up:nth-child(1){animation-delay:.1s}
    .fade-up:nth-child(2){animation-delay:.18s}
    .fade-up:nth-child(3){animation-delay:.26s}
    .fade-up:nth-child(4){animation-delay:.34s}
    .fade-up:nth-child(5){animation-delay:.42s}
    @keyframes rise{
      to{
        opacity:1;
        transform:translateY(0) scale(1);
        filter:blur(0);
      }
    }
    @media (prefers-reduced-motion: reduce){
      .blob{animation:none}
      .fade-up{opacity:1; transform:none; filter:none; animation:none}
      .status-card.selected{animation:none}
      .status-card.selected.completed{animation:none}
      .status-card:hover{transform:none}
    }
  </style>
</head>

<body>
  <div class="blob-container" aria-hidden="true">
    <div class="blob b1"></div>
    <div class="blob b2"></div>
    <div class="blob b3"></div>
  </div>

  <main class="shell" role="main">
    <!-- LEFT: main interaction -->
    <section class="panel main" aria-label="ê°œì¸ ìƒíƒœ ê´€ë¦¬">
      <!-- ìƒë‹¨ ë¡œê·¸ì¸/í”„ë¡œí•„ ë°” -->
      <div class="bar">
        <div class="who" id="loginStatus" aria-live="polite">
          <span class="dot" aria-hidden="true"></span>
          <div>
            <div class="name">ë¡œê·¸ì¸ë¨</div>
            <div class="meta" id="userMeta">-í•™ë…„ -ë°˜ -ë²ˆ</div>
          </div>
        </div>
        <div class="thought-trigger">
          <!-- Legacy chat button - moved to /chat.html -->
          <!-- <button class="btn ghost" type="button" id="thoughtOpenBtn" aria-label="ìƒê° ì˜¬ë¦¬ê¸°" style="position:relative">
            ğŸ’¬
            <span id="chatBadge" class="chat-badge" style="display:none"></span>
          </button> -->
          <button class="btn ghost" type="button" id="logoutBtn" aria-label="ë¡œê·¸ì•„ì›ƒ">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
      </div>

      <!-- í˜„ì¬ ìƒíƒœ í‘œì‹œ -->
      <div class="now" role="region" aria-labelledby="now-title">
        <h3 id="now-title">í˜„ì¬ ì„ íƒëœ ìƒíƒœ<span id="unsavedIndicator" style="font-size: 0.7em; color: #ff7a7a; margin-left: 8px; display: none;">(ì €ì¥ ì•ˆ ë¨)</span></h3>
        <div class="val" id="currentStatus">êµì‹¤</div>
      </div>

      <!-- ìƒíƒœ ì„ íƒ -->
      <div>
        <div class="section-head">ë‚´ ìœ„ì¹˜/ìƒíƒœ ì„ íƒ</div>
        <div class="grid" id="statusGrid">
          <div class="status-card" data-status="í™”ì¥ì‹¤(ë¬¼)" tabindex="0" role="button" aria-label="í™”ì¥ì‹¤(ë¬¼)">
            <div class="status-label">ë³€ì†Œ(ë¬¼)</div>
            <div class="status-desc">í™”ì¥ì‹¤ í™˜í’êµ¬ë¡œ ì‚°íƒ€ ì˜ì ‘</div>
          </div>
          <div class="status-card" data-status="ë³µë„" tabindex="0" role="button" aria-label="ë³µë„">
            <div class="status-label">ë³µë„</div>
            <div class="status-desc">ë³µë„ì—ì„œ ë£¨ëŒí”„ ë°¥ì£¼ê¸°</div>
          </div>
          <div class="status-card" data-status="ë™ì•„ë¦¬" tabindex="0" role="button" aria-label="ë™ì•„ë¦¬">
            <div class="status-label">ë™ì•„ë¦¬</div>
            <div class="status-desc">ë™ì•„ë¦¬ì—ì„œ ì„ ë¬¼ ì£¼ê³ ë°›ê¸°</div>
          </div>
          <div class="status-card" data-status="ë°©ê³¼í›„" tabindex="0" role="button" aria-label="ë°©ê³¼í›„">
            <div class="status-label">ë°©ê³¼í›„</div>
            <div class="status-desc">ì‚°íƒ€ì™€ì˜ ë©´ë‹´</div>
          </div>
          <div class="status-card" data-status="í”„ë¡œì íŠ¸" tabindex="0" role="button" aria-label="í”„ë¡œì íŠ¸">
            <div class="status-label">í”„ë¡œì íŠ¸</div>
            <div class="status-desc">ì‚°íƒ€ì˜ ì„ ë¬¼ ê³µì¥</div>
          </div>
          <div class="status-card" data-status="ì¡°ê¸°ì…ì‹¤" tabindex="0" role="button" aria-label="ì¡°ê¸°ì…ì‹¤">
            <div class="status-label">ì¡°ê¸°ì…ì‹¤</div>
            <div class="status-desc">ë¨¸ë¦¬ë§¡ì— ì„ ë¬¼ì´ ìˆë‚˜ í™•ì¸í•˜ëŸ¬ ê°</div>
          </div>

          <!-- ê¸°íƒ€ -->
          <div class="status-card" data-status="ê¸°íƒ€" tabindex="0" role="button" aria-label="ê¸°íƒ€">
            <div class="status-label">ê¸°íƒ€</div>
            <div class="status-desc">ì‚¬ìœ  ì§ì ‘ ì…ë ¥</div>
            <div class="etc-box" id="etcBox" aria-hidden="true">
              <div class="etc-row">
                <input id="etcInput" class="input" type="text" placeholder="ì˜ˆ: êµ´ëš ë“¤ì–´ê°€ê¸°, ë£¨ëŒí”„ ì¡°ë ¨ ë“± ì…ë ¥" />
                <button id="etcAddBtn" class="btn ghost" type="button" style="min-width:72px">ì¶”ê°€</button>
              </div>
              <div id="etcChips" class="chip-list" aria-live="polite"></div>
            </div>
          </div>

          <div class="status-card" data-status="ê²°ì„(ì¡°í‡´)" tabindex="0" role="button" aria-label="ê²°ì„(ì¡°í‡´)">
            <div class="status-label">ê²°ì„(ì¡°í‡´)</div>
            <div class="status-desc"> ìš°ë¦¬ì§‘ì— ì„ ë¬¼ ìˆë‚˜ ë³´ëŸ¬ ë£¨ëŒí”„ íƒ€ê³  ê°</div>
          </div>
        </div>
      </div>

      <div class="status-card" data-status="êµì‹¤" tabindex="0" role="button" aria-label="êµì‹¤">
          <div class="status-label">êµì‹¤</div>
          <div class="status-desc">êµ´ëšì´ ì—†ë„¤ìš”</div>
      </div>

      <!-- ì™„ë£Œ -->
      <div class="submit-wrap">
        <button class="btn cta" id="submitBtn" type="button" aria-label="ìƒíƒœ ì €ì¥">ì™„ë£Œ</button>
      </div>
    </section>

    <!-- RIGHT: brand / highlights -->
    <section class="panel side" aria-label="ë¸Œëœë“œ & í•˜ì´ë¼ì´íŠ¸">
      <div class="time" id="timeDisplay" aria-live="polite"></div>

      <div class="brand fade-up">
        <img class="logo" aria-hidden="true" src="/src/dimicheck_templogo.png" alt="">
        <div>DimiCheck</div>
      </div>

      <div class="bigcopy fade-up">
        <h1 class="h1">í•œ ë²ˆì˜ íƒ­ìœ¼ë¡œ<br/>ë‚´ ìƒíƒœë¥¼ ì •í™•íˆ</h1>
        <p class="p">ë””ë¯¸ê³ ë¥¼ ìœ„í•œ ìƒˆë¡œìš´ <s style="color: #4f4f4f; font-size: 0.8em">ì¶œê²°Â·ìƒíƒœ í”Œë«í¼</s> ì‚°íƒ€ ì˜ì ‘ í”Œë«í¼</p>
      </div>

      <div class="hero-cta fade-up" aria-label="í•˜ì´ë¼ì´íŠ¸">
        <div class="chipx">ê°„í¸í•œ ì¶œê²° ì¸ì¦</div>
        <div class="chipx">ì›ê²© ìƒíƒœ í™•ì¸</div>
        <div class="chipx">ì‹¤ì‹œê°„ ë™ê¸°í™”</div>
      </div>

      <svg class="illus" viewBox="0 0 600 380" fill="none" aria-hidden="true">
        <defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
          <stop offset="0%" stop-color="var(--primary)"/><stop offset="100%" stop-color="var(--primary-2)"/>
        </linearGradient></defs>
        <rect x="30" y="40" width="540" height="300" rx="26" fill="url(#g)" opacity=".18"/>
        <rect x="60" y="70" width="480" height="60" rx="14" fill="#fff" opacity=".14"/>
        <rect x="60" y="150" width="240" height="180" rx="18" fill="#fff" opacity=".12"/>
        <rect x="320" y="150" width="220" height="120" rx="18" fill="#fff" opacity=".1"/>
        <circle cx="520" cy="110" r="10" fill="#fff" opacity=".8"/>
        <circle cx="490" cy="110" r="10" fill="#fff" opacity=".6"/>
        <circle cx="460" cy="110" r="10" fill="#fff" opacity=".4"/>
      </svg>
    </section>
    <div class="spacer"></div>
  </main>

  <!-- ===== LEGACY: Chat/Vote/Reaction Modals - Moved to /chat.html ===== -->
  <!--
  <div id="thoughtOverlay" class="thought-overlay" hidden>
    <div class="thought-dialog" role="dialog" aria-modal="true" aria-labelledby="thoughtTitle" style="max-width:680px;width:90vw;max-height:88vh;overflow-y:auto">
      <button class="thought-close" type="button" id="thoughtCloseBtn" aria-label="ë‹«ê¸°">Ã—</button>
      <h2 id="thoughtTitle">ğŸ’¬ ì±„íŒ…</h2>

      <div class="chat-container">
        <div class="chat-messages" id="chatMessages"></div>

        <div class="chat-input-container">
          <input type="text" id="chatInput" class="chat-input" maxlength="140" placeholder="ë©”ì‹œì§€ ì…ë ¥ (140ì)" />
          <button class="btn cta" id="chatSendBtn" type="button" style="max-width:44px;padding:0 12px;font-size:20px">â†‘</button>
        </div>

        <div class="chat-toolbar">
          <button class="btn ghost" id="voteCreateBtn" type="button">ğŸ“Š íˆ¬í‘œ ë§Œë“¤ê¸°</button>
          <button class="btn ghost" id="reactionBtn" type="button">ğŸ˜Š ë°˜ì‘</button>
        </div>
      </div>

      <div id="voteContainer" class="vote-container">
        <div class="vote-header">
          <h3 class="vote-question" id="voteQuestion">íˆ¬í‘œ ì§ˆë¬¸</h3>
          <div class="vote-countdown" id="voteCountdown">2:00</div>
        </div>
        <div class="vote-options" id="voteOptions"></div>
        <button class="btn cta" id="voteSubmitBtn" type="button">íˆ¬í‘œí•˜ê¸°</button>
      </div>

      <p class="thought-hint">ë©”ì‹œì§€ëŠ” ë‹¹ì¼ë§Œ ë³´ê´€ë˜ë©°, ì „ìì¹ íŒì— 5ì´ˆê°„ ë§í’ì„ ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.</p>
    </div>
  </div>

  <div id="voteCreateOverlay" class="thought-overlay" hidden>
    <div class="thought-dialog" role="dialog" aria-modal="true">
      <button class="thought-close" type="button" id="voteCreateCloseBtn">Ã—</button>
      <h2>ğŸ“Š íˆ¬í‘œ ë§Œë“¤ê¸°</h2>

      <input type="text" id="voteQuestionInput" class="input" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš” (ìµœëŒ€ 200ì)" maxlength="200" style="margin-bottom:12px" />

      <div style="margin-bottom:12px">
        <label style="font-size:13px;color:var(--muted);margin-bottom:6px;display:block">íˆ¬í‘œ ì˜µì…˜ (2~10ê°œ)</label>
        <div id="voteOptionsList" style="display:flex;flex-direction:column;gap:8px"></div>
        <button class="btn ghost" id="voteAddOptionBtn" type="button" style="margin-top:8px;width:100%">+ ì˜µì…˜ ì¶”ê°€</button>
      </div>

      <div style="margin-bottom:16px">
        <label style="font-size:13px;color:var(--muted);margin-bottom:6px;display:block">ìµœëŒ€ ì„ íƒ ê°€ëŠ¥ ê°œìˆ˜</label>
        <input type="number" id="voteMaxChoices" class="input" value="1" min="1" max="10" />
      </div>

      <div class="thought-actions">
        <button class="btn cta" id="voteCreateSubmitBtn" type="button">íˆ¬í‘œ ìƒì„±</button>
        <button class="btn ghost" id="voteCreateCancelBtn" type="button">ì·¨ì†Œ</button>
      </div>

      <p class="thought-feedback" id="voteCreateFeedback"></p>
    </div>
  </div>

  <div id="reactionModal" class="thought-overlay" hidden>
    <div class="thought-dialog" role="dialog" aria-modal="true">
      <button class="thought-close" type="button" id="reactionCloseBtn">Ã—</button>
      <h2>ğŸ˜Š ë°˜ì‘ ì„ íƒ</h2>

      <div class="reaction-picker" id="reactionPicker"></div>

      <p class="reaction-cooldown" id="reactionCooldown"></p>
      <p class="reaction-feedback" id="reactionFeedback"></p>
      <p class="thought-hint">ë°˜ì‘ì€ 5ì´ˆê°„ ì „ìì¹ íŒì˜ ìì„ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
    </div>
  </div>

  <div id="chatToast" class="chat-toast" style="display:none"></div>
  -->

  <script>
    // ===== ê¸€ë¡œë²Œ ìƒíƒœ =====
    let myGrade = null, mySection = null, myNumber = null;
    let selectedStatus = null;
    let lastSavedStatus = null;
    const currentStatusDisplay = document.getElementById('currentStatus');

    // Get the unsaved indicator element
    const unsavedIndicator = document.getElementById('unsavedIndicator');

    // ê¸°íƒ€ ì…ë ¥ ê´€ë¦¬
    const etcCard  = document.querySelector('.status-card[data-status="ê¸°íƒ€"]');
    const etcBox   = document.getElementById('etcBox');
    const etcInput = document.getElementById('etcInput');
    const etcAddBtn= document.getElementById('etcAddBtn');
    const etcChips = document.getElementById('etcChips');
    const etcItems = []; // For single value display

    // ì±„íŒ…/íˆ¬í‘œ/ë°˜ì‘ ê´€ë ¨
    const thoughtOverlay = document.getElementById('thoughtOverlay');
    const thoughtOpenBtn = document.getElementById('thoughtOpenBtn');
    const thoughtCloseBtn = document.getElementById('thoughtCloseBtn');

    // ë¼ë²¨ ë³€í™˜
    const categoryLabels = {
      toilet: "í™”ì¥ì‹¤(ë¬¼)",
      hallway: "ë³µë„",
      club: "ë™ì•„ë¦¬",
      afterschool: "ë°©ê³¼í›„",
      project: "í”„ë¡œì íŠ¸",
      early: "ì¡°ê¸°ì…ì‹¤",
      etc: "ê¸°íƒ€",
      absence: "ê²°ì„(ì¡°í‡´)",
      section: "êµì‹¤",
    };
    const reverseCategoryLabels = Object.fromEntries(
      Object.entries(categoryLabels).map(([k, v]) => [v, k])
    );

    // ===== ì‹œê°„ í‘œì‹œ =====
    function updateTime() {
      const now = new Date();
      const s = now.toLocaleString('ko-KR', {hour:'2-digit', minute:'2-digit', second:'2-digit'});
      document.getElementById('timeDisplay').textContent = s;
    }
    updateTime(); setInterval(updateTime, 1000);

    // ì±„íŒ… ë‹¤ì´ì–¼ë¡œê·¸ ì—´ê¸°/ë‹«ê¸°
    function openChatDialog() {
      if (!thoughtOverlay) return;
      thoughtOverlay.hidden = false;
      // ì±„íŒ… ë§¤ë‹ˆì € ì—´ê¸°
      if (window.chatManager) {
        window.chatManager.open();
      }
      // íˆ¬í‘œ ë§¤ë‹ˆì € ì´ˆê¸°í™”
      if (window.votingManager) {
        window.votingManager.init(myGrade, mySection, myNumber);
      }
      // ë°˜ì‘ ë§¤ë‹ˆì € ì´ˆê¸°í™”
      if (window.reactionsManager) {
        window.reactionsManager.init(myGrade, mySection, myNumber);
      }
    }

    function closeChatDialog() {
      if (!thoughtOverlay) return;
      thoughtOverlay.hidden = true;
      // ì±„íŒ… í´ë§ ì¤‘ì§€
      if (window.chatManager) {
        window.chatManager.close();
      }
    }

    // ===== ë¡œê·¸ì¸ ì²´í¬ & í˜„ì¬ ìƒíƒœ ë¶ˆëŸ¬ì˜¤ê¸° =====
    async function checkLogin() {
      try {
        const res = await fetch("/auth/status", { credentials: "include" });
        if (!res) { location.href = "/auth/login"; return; }
        const data = await res.json();

        if (!data.logged_in) { location.href = "/auth/login"; return; }

        if (Number.isFinite(data.grade) && Number.isFinite(data.section) && Number.isFinite(data.number)) {
          myGrade = data.grade;
          mySection = data.section;
          myNumber = data.number;
        } else {
          const composite = Number.isFinite(data.number) ? data.number : 0;
          myGrade   = Math.floor(composite/1000);
          mySection = Math.floor((composite%1000)/100);
          myNumber  = Math.floor(composite%100);
        }

        document.getElementById("userMeta").textContent =
          `${myGrade}í•™ë…„ ${mySection}ë°˜ ${myNumber}ë²ˆ`;

        try {
          localStorage.setItem('dimicheck:class-context', JSON.stringify({ grade: myGrade, section: mySection }));
        } catch (err) {
          console.warn('[Notifications] failed to cache class context', err);
        }
        window.notificationManager?.setClassContext?.({
          grade: myGrade,
          section: mySection
        });

        // ì±„íŒ… ë§¤ë‹ˆì € ì´ˆê¸°í™” (ë°±ê·¸ë¼ìš´ë“œ í´ë§ ì‹œì‘)
        if (window.chatManager) {
          window.chatManager.init(myGrade, mySection, myNumber);
        }

        await loadMyState();
      } catch (e) {
        console.warn("checkLogin failed:", e);
        location.href = "/auth/login";
      }
    }

    async function loadMyState() {
      try {
        const res = await fetch(`/api/classes/state/load?grade=${myGrade}&section=${mySection}`);
        if (!res.ok) throw new Error("ìƒíƒœ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
        const parsed = await res.json();
        const magnets = parsed.magnets || {};
        const me = magnets[myNumber];

        if (!me) {
          currentStatusDisplay.textContent = "êµì‹¤";
          lastSavedStatus = "êµì‹¤";
          return;
        }

        if (me.attachedTo === "etc" && me.reason) {
          currentStatusDisplay.textContent = `ê¸°íƒ€ - ${me.reason}`;
          lastSavedStatus = `ê¸°íƒ€ - ${me.reason}`;
        } else {
          const label = categoryLabels[me.attachedTo] || me.attachedTo;
          currentStatusDisplay.textContent = label || "êµì‹¤";
          lastSavedStatus = label || "êµì‹¤";
        }
      } catch (e) {
        console.error("loadMyState error:", e);
        currentStatusDisplay.textContent = "êµì‹¤";
      }
    }

    // ===== ìƒíƒœ ì¹´ë“œ ì„ íƒ ì²˜ë¦¬ =====
    function refreshCurrentStatus() {
      let displayStatus = selectedStatus ?? 'â€”';
      let isUnsaved = false;

      if (selectedStatus === 'ê¸°íƒ€' && etcItems.length > 0) {
        displayStatus = `ê¸°íƒ€ - ${etcItems[0]}`;
      }

      // ìŠ¤í¬ë¡¤ ì• ë‹ˆë©”ì´ì…˜ìœ¼ë¡œ í…ìŠ¤íŠ¸ ë³€ê²½
      currentStatusDisplay.classList.add('status-scroll-out');
      setTimeout(() => {
        currentStatusDisplay.textContent = displayStatus;
        currentStatusDisplay.classList.remove('status-scroll-out');
        currentStatusDisplay.classList.add('status-scroll-in');
        setTimeout(() => {
          currentStatusDisplay.classList.remove('status-scroll-in');
        }, 350);
      }, 350);

      // Determine if it's unsaved
      if (selectedStatus && displayStatus !== lastSavedStatus) {
        isUnsaved = true;
      }

      // ì €ì¥ ì•ˆë¨ ìŠ¬ë¼ì´ë“œ ì• ë‹ˆë©”ì´ì…˜
      if (unsavedIndicator) {
        const wasVisible = unsavedIndicator.style.display !== 'none';
        if (isUnsaved && !wasVisible) {
          unsavedIndicator.style.display = 'inline';
          unsavedIndicator.classList.remove('unsaved-slide-out');
          unsavedIndicator.classList.add('unsaved-slide-in');
        } else if (!isUnsaved && wasVisible) {
          unsavedIndicator.classList.remove('unsaved-slide-in');
          unsavedIndicator.classList.add('unsaved-slide-out');
          setTimeout(() => {
            unsavedIndicator.style.display = 'none';
            unsavedIndicator.classList.remove('unsaved-slide-out');
          }, 400);
        }
      }
    }

    function setSelected(card) {
      const wasSelected = selectedStatus === card.dataset.status;

      // í•´ì œ
      if (wasSelected) {
        card.classList.remove('selected','completed');
        selectedStatus = null;
        etcBox.style.display = 'none';
        etcBox.setAttribute('aria-hidden','true');
        refreshCurrentStatus();
        return;
      }

      // ìƒˆ ì„ íƒ
      document.querySelectorAll('.status-card').forEach(c => c.classList.remove('selected','completed'));
      card.classList.add('selected');
      selectedStatus = card.dataset.status;

      const isEtc = selectedStatus === 'ê¸°íƒ€';
      etcBox.style.display = isEtc ? 'flex' : 'none';
      etcBox.setAttribute('aria-hidden', String(!isEtc));
      if (isEtc) etcInput?.focus();

      refreshCurrentStatus();
    }

    // í‚¤ë³´ë“œ ì ‘ê·¼ì„±(Enter/Space)
    document.querySelectorAll('.status-card').forEach(card => {
      card.addEventListener('click', () => setSelected(card));
      card.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          setSelected(card);
        }
      });
    });

    // ê¸°íƒ€ ì…ë ¥
    function renderChips() {
      etcChips.innerHTML = '';
      etcItems.forEach((txt, idx) => {
        const chip = document.createElement('span');
        chip.className = 'chip';
        chip.innerHTML = `<span>${txt}</span><button class="del" aria-label="ì‚­ì œ" data-idx="${idx}">Ã—</button>`;
        etcChips.appendChild(chip);
      });
    }
    function addEtcItem(text) {
      if (!text) return;
      etcItems.length = 0; // ë‹¨ì¼ ìœ ì§€
      etcItems.push(text.trim());
      renderChips();
      etcInput.value = '';
      refreshCurrentStatus();
    }

    [etcInput, etcAddBtn, etcChips].forEach(el => {
      el.addEventListener('click', (e) => e.stopPropagation());
    });
    etcAddBtn.addEventListener('click', () => addEtcItem(etcInput.value));
    etcInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') { e.preventDefault(); addEtcItem(etcInput.value); }
    });
    etcChips.addEventListener('click', (e) => {
      const btn = e.target.closest('.del');
      if (!btn) return;
      const idx = Number(btn.dataset.idx);
      etcItems.splice(idx,1);
      renderChips();
      refreshCurrentStatus();
    });

    // ===== LEGACY: Chat/Vote/Reaction Event Handlers - Moved to /chat.html =====
    /*
    // ì±„íŒ… ë‹¤ì´ì–¼ë¡œê·¸ ì´ë²¤íŠ¸
    if (thoughtOpenBtn) {
      thoughtOpenBtn.addEventListener('click', openChatDialog);
    }
    if (thoughtCloseBtn) {
      thoughtCloseBtn.addEventListener('click', closeChatDialog);
    }
    if (thoughtOverlay) {
      thoughtOverlay.addEventListener('mousedown', (e) => {
        if (e.target === thoughtOverlay) {
          closeChatDialog();
        }
      });
    }
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if (thoughtOverlay && !thoughtOverlay.hidden) closeChatDialog();
        const voteCreateOverlay = document.getElementById('voteCreateOverlay');
        const reactionModal = document.getElementById('reactionModal');
        if (voteCreateOverlay && !voteCreateOverlay.hidden) voteCreateOverlay.hidden = true;
        if (reactionModal && !reactionModal.hidden) reactionModal.hidden = true;
      }
    });

    // ì±„íŒ… ì „ì†¡
    const chatSendBtn = document.getElementById('chatSendBtn');
    const chatInput = document.getElementById('chatInput');
    if (chatSendBtn) {
      chatSendBtn.addEventListener('click', async () => {
        const text = chatInput?.value;
        if (!text) return;
        const result = await window.chatManager.sendMessage(text);
        if (result.success) {
          chatInput.value = '';
        } else {
          alert(result.error || 'ë©”ì‹œì§€ë¥¼ ë³´ë‚´ì§€ ëª»í–ˆì–´ìš”.');
        }
      });
    }
    if (chatInput) {
      chatInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          chatSendBtn?.click();
        }
      });
    }

    // íˆ¬í‘œ ìƒì„± ë²„íŠ¼
    const voteCreateBtn = document.getElementById('voteCreateBtn');
    if (voteCreateBtn) {
      voteCreateBtn.addEventListener('click', () => {
        const overlay = document.getElementById('voteCreateOverlay');
        if (overlay) overlay.hidden = false;
        initVoteCreateModal();
      });
    }

    // íˆ¬í‘œ ì œì¶œ
    const voteSubmitBtn = document.getElementById('voteSubmitBtn');
    if (voteSubmitBtn) {
      voteSubmitBtn.addEventListener('click', async () => {
        const result = await window.votingManager.submitVote();
        if (!result.success) {
          alert(result.error || 'íˆ¬í‘œë¥¼ ì œì¶œí•˜ì§€ ëª»í–ˆì–´ìš”.');
        }
      });
    }

    // ë°˜ì‘ ë²„íŠ¼
    const reactionBtn = document.getElementById('reactionBtn');
    if (reactionBtn) {
      reactionBtn.addEventListener('click', () => {
        window.reactionsManager.openPicker();
      });
    }

    const reactionCloseBtn = document.getElementById('reactionCloseBtn');
    if (reactionCloseBtn) {
      reactionCloseBtn.addEventListener('click', () => {
        window.reactionsManager.closePicker();
      });
    }

    // íˆ¬í‘œ ìƒì„± ëª¨ë‹¬ ì´ˆê¸°í™”
    function initVoteCreateModal() {
      const optionsList = document.getElementById('voteOptionsList');
      if (!optionsList) return;

      optionsList.innerHTML = '';
      // ê¸°ë³¸ 2ê°œ ì˜µì…˜
      addVoteOption();
      addVoteOption();
    }

    function addVoteOption() {
      const optionsList = document.getElementById('voteOptionsList');
      if (!optionsList) return;

      const count = optionsList.children.length;
      if (count >= 10) {
        alert('ì˜µì…˜ì€ ìµœëŒ€ 10ê°œê¹Œì§€ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        return;
      }

      const optionDiv = document.createElement('div');
      optionDiv.style.cssText = 'display:flex;gap:8px';

      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'input';
      input.placeholder = `ì˜µì…˜ ${count + 1}`;
      input.maxLength = 100;
      input.style.flex = '1';

      const delBtn = document.createElement('button');
      delBtn.className = 'btn ghost';
      delBtn.textContent = 'Ã—';
      delBtn.type = 'button';
      delBtn.style.minWidth = '44px';
      delBtn.style.padding = '10px';
      delBtn.addEventListener('click', () => {
        optionDiv.remove();
      });

      optionDiv.appendChild(input);
      optionDiv.appendChild(delBtn);
      optionsList.appendChild(optionDiv);
    }

    const voteAddOptionBtn = document.getElementById('voteAddOptionBtn');
    if (voteAddOptionBtn) {
      voteAddOptionBtn.addEventListener('click', addVoteOption);
    }

    const voteCreateSubmitBtn = document.getElementById('voteCreateSubmitBtn');
    const voteCreateCancelBtn = document.getElementById('voteCreateCancelBtn');
    const voteCreateCloseBtn = document.getElementById('voteCreateCloseBtn');

    if (voteCreateSubmitBtn) {
      voteCreateSubmitBtn.addEventListener('click', async () => {
        const question = document.getElementById('voteQuestionInput')?.value;
        const optionsList = document.getElementById('voteOptionsList');
        const options = Array.from(optionsList?.querySelectorAll('input') || [])
          .map(input => input.value.trim())
          .filter(v => v);
        const maxChoices = parseInt(document.getElementById('voteMaxChoices')?.value || '1');

        const feedback = document.getElementById('voteCreateFeedback');
        const result = await window.votingManager.createVote(question, options, maxChoices);

        if (result.success) {
          if (feedback) {
            feedback.textContent = 'íˆ¬í‘œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!';
            feedback.className = 'thought-feedback success';
          }
          setTimeout(() => {
            document.getElementById('voteCreateOverlay').hidden = true;
          }, 1000);
        } else {
          if (feedback) {
            feedback.textContent = result.error || 'íˆ¬í‘œë¥¼ ìƒì„±í•˜ì§€ ëª»í–ˆì–´ìš”.';
            feedback.className = 'thought-feedback error';
          }
        }
      });
    }

    if (voteCreateCancelBtn) {
      voteCreateCancelBtn.addEventListener('click', () => {
        document.getElementById('voteCreateOverlay').hidden = true;
      });
    }

    if (voteCreateCloseBtn) {
      voteCreateCloseBtn.addEventListener('click', () => {
        document.getElementById('voteCreateOverlay').hidden = true;
      });
    }
    */

    // ===== ì €ì¥ =====
    async function saveMyState(statusLabel, reason = null) {
      if (!myGrade || !mySection || !myNumber) { alert("ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }
      const key = reverseCategoryLabels[statusLabel] || statusLabel;

      const magnets = {};
      magnets[myNumber] = { attachedTo: key, reason: reason };

      try {
        const res = await fetch(`/api/classes/state/save?grade=${myGrade}&section=${mySection}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ magnets })
        });
        if (!res.ok) throw new Error(await res.text());
        // ì™„ë£Œ ë¹„ì£¼ì–¼
        const selected = document.querySelector('.status-card.selected');
        selected?.classList.add('completed');
        lastSavedStatus = selectedStatus;
      } catch (e) {
        console.error("saveMyState failed:", e);
        alert("ì €ì¥ ì‹¤íŒ¨: " + e.message);
      }
    }

    document.getElementById('submitBtn').addEventListener('click', async () => {
      if (!selectedStatus) { alert("ìƒíƒœë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”."); return; }
      const reason = (selectedStatus === "ê¸°íƒ€" && etcItems.length > 0) ? etcItems[0] : null;
      const submitBtn = document.getElementById('submitBtn');

      // ì €ì¥ ì‹œì‘
      submitBtn.textContent = 'ì €ì¥ ì¤‘...';
      submitBtn.disabled = true;

      await saveMyState(selectedStatus, reason);

      // ì„±ê³µ ì• ë‹ˆë©”ì´ì…˜
      submitBtn.classList.add('success-animation');
      submitBtn.textContent = 'ì™„ë£Œë¨';
      setTimeout(() => {
        submitBtn.textContent = 'ì™„ë£Œ';
        submitBtn.disabled = false;
        submitBtn.classList.remove('success-animation');
      }, 2000);

      refreshCurrentStatus();
    });

    // ===== ë¡œê·¸ì•„ì›ƒ (ì„ íƒ) =====
    document.getElementById('logoutBtn').addEventListener('click', () => {
      location.href = '/auth/logout';
    });

    // ì§„ì… ì‹œ ë¡œê·¸ì¸ í™•ì¸
    checkLogin();
  </script>
  <nav class="bottom-nav" aria-label="í•˜ë‹¨ ë‚´ë¹„ê²Œì´ì…˜">
    <a href="/schoollife.html" class="nav-item">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 3 1 9l4 2.18v6.32L12 21l7-3.5V11.18L23 9 12 3zm0 2.69L17.53 9 12 11.31 6.47 9 12 5.69zM18 17.18l-5 2.5v-5.81l5-2.5v5.81z"/></svg>
      <span>í•™êµìƒí™œ</span>
    </a>
    <a href="/routine.html" class="nav-item">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M7 2a1 1 0 0 1 1 1v1h8V3a1 1 0 1 1 2 0v1h1a3 3 0 0 1 3 3v11a3 3 0 0 1-3 3H4a3 3 0 0 1-3-3V7a3 3 0 0 1 3-3h1V3a1 1 0 0 1 1-1Zm13 8H4v9a1 1 0 0 0 1 1h14a1 1 0 0 0 1-1v-9ZM6 7h12V6H6v1Z"/></svg>
      <span>ë£¨í‹´</span>
    </a>
    <a href="/user.html" class="nav-item active" aria-current="page">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
      <span>í™ˆ</span>
    </a>
    <a href="/chat.html" class="nav-item">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/></svg>
      <span>ì±„íŒ…</span>
    </a>
    <a href="/my.html" class="nav-item">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5zm0 2c-3.33 0-10 1.67-10 5v3h20v-3c0-3.33-6.67-5-10-5z"/></svg>
      <span>ë§ˆì´</span>
    </a>
  </nav>
</body>
</html>
